{"version":3,"file":"index.esm.js","sources":["../src/apis/ApiAggregator.ts","../src/apis/ApiProvider.tsx","../src/apis/ApiRegistry.ts","../src/apis/ApiRef.ts","../src/apis/helpers.ts","../src/apis/definitions/auth.ts","../src/apis/definitions/AlertApi.ts","../src/apis/definitions/AppThemeApi.ts","../src/apis/definitions/ConfigApi.ts","../src/apis/definitions/ErrorApi.ts","../src/apis/definitions/FeatureFlagsApi.ts","../src/apis/definitions/DiscoveryApi.ts","../src/apis/definitions/IdentityApi.ts","../src/apis/definitions/OAuthRequestApi.ts","../src/apis/definitions/StorageApi.ts","../src/lib/loginPopup.ts","../src/lib/AuthConnector/DefaultAuthConnector.ts","../src/lib/AuthConnector/DirectAuthConnector.ts","../src/lib/AuthSessionManager/common.ts","../src/lib/subjects.ts","../src/lib/AuthSessionManager/SessionStateTracker.ts","../src/lib/AuthSessionManager/RefreshingAuthSessionManager.ts","../src/lib/AuthSessionManager/StaticAuthSessionManager.ts","../src/lib/AuthSessionManager/AuthSessionStore.ts","../src/apis/implementations/auth/github/GithubAuth.ts","../src/apis/implementations/auth/oauth2/OAuth2.ts","../src/apis/implementations/auth/gitlab/GitlabAuth.ts","../src/apis/implementations/auth/google/GoogleAuth.ts","../src/apis/implementations/auth/okta/OktaAuth.ts","../src/apis/implementations/auth/saml/SamlAuth.ts","../src/apis/implementations/auth/auth0/Auth0Auth.ts","../src/apis/implementations/auth/microsoft/MicrosoftAuth.ts","../src/apis/implementations/AlertApi/AlertApiForwarder.ts","../src/apis/implementations/AppThemeApi/AppThemeSelector.ts","../src/apis/implementations/ErrorApi/ErrorAlerter.ts","../src/apis/implementations/ErrorApi/ErrorApiForwarder.ts","../src/apis/implementations/DiscoveryApi/UrlPatternDiscovery.ts","../src/apis/implementations/OAuthRequestApi/OAuthPendingRequests.ts","../src/apis/implementations/OAuthRequestApi/OAuthRequestManager.ts","../src/apis/implementations/StorageApi/WebStorage.ts","../src/app/FeatureFlags.tsx","../src/app/AppContext.tsx","../src/icons/icons.tsx","../src/plugin/Plugin.tsx","../src/routing/types.ts","../src/routing/RouteRef.ts","../src/app/AppThemeProvider.tsx","../src/app/AppIdentity.ts","../src/apis/ApiFactoryRegistry.ts","../src/apis/ApiResolver.ts","../src/app/App.tsx"],"sourcesContent":["/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ApiRef } from './ApiRef';\nimport { ApiHolder } from './types';\n\n/**\n * An ApiHolder that queries multiple other holders from for\n * an Api implementation, returning the first one encountered..\n */\nexport class ApiAggregator implements ApiHolder {\n  private readonly holders: ApiHolder[];\n\n  constructor(...holders: ApiHolder[]) {\n    this.holders = holders;\n  }\n\n  get<T>(apiRef: ApiRef<T>): T | undefined {\n    for (const holder of this.holders) {\n      const api = holder.get(apiRef);\n      if (api) {\n        return api;\n      }\n    }\n    return undefined;\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { FC, createContext, useContext, ReactNode } from 'react';\nimport PropTypes from 'prop-types';\nimport { ApiRef } from './ApiRef';\nimport { ApiHolder, TypesToApiRefs } from './types';\nimport { ApiAggregator } from './ApiAggregator';\n\ntype ApiProviderProps = {\n  apis: ApiHolder;\n  children: ReactNode;\n};\n\nconst Context = createContext<ApiHolder | undefined>(undefined);\n\nexport const ApiProvider: FC<ApiProviderProps> = ({ apis, children }) => {\n  const parentHolder = useContext(Context);\n  const holder = parentHolder ? new ApiAggregator(apis, parentHolder) : apis;\n\n  return <Context.Provider value={holder} children={children} />;\n};\n\nApiProvider.propTypes = {\n  apis: PropTypes.shape({ get: PropTypes.func.isRequired }).isRequired,\n  children: PropTypes.node,\n};\n\nexport function useApiHolder(): ApiHolder {\n  const apiHolder = useContext(Context);\n\n  if (!apiHolder) {\n    throw new Error('No ApiProvider available in react context');\n  }\n\n  return apiHolder;\n}\n\nexport function useApi<T>(apiRef: ApiRef<T>): T {\n  const apiHolder = useApiHolder();\n\n  const api = apiHolder.get(apiRef);\n  if (!api) {\n    throw new Error(`No implementation available for ${apiRef}`);\n  }\n  return api;\n}\n\nexport function withApis<T>(apis: TypesToApiRefs<T>) {\n  return function withApisWrapper<P extends T>(\n    WrappedComponent: React.ComponentType<P>,\n  ) {\n    const Hoc: FC<Omit<P, keyof T>> = props => {\n      const apiHolder = useContext(Context);\n\n      if (!apiHolder) {\n        throw new Error('No ApiProvider available in react context');\n      }\n\n      const impls = {} as T;\n\n      for (const key in apis) {\n        if (apis.hasOwnProperty(key)) {\n          const ref = apis[key];\n\n          const api = apiHolder.get(ref);\n          if (!api) {\n            throw new Error(`No implementation available for ${ref}`);\n          }\n          impls[key] = api;\n        }\n      }\n\n      return <WrappedComponent {...(props as P)} {...impls} />;\n    };\n    const displayName =\n      WrappedComponent.displayName || WrappedComponent.name || 'Component';\n\n    Hoc.displayName = `withApis(${displayName})`;\n\n    return Hoc;\n  };\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ApiRef } from './ApiRef';\nimport { ApiHolder } from './types';\n\ntype ApiImpl<T = unknown> = readonly [ApiRef<T>, T];\n\nclass ApiRegistryBuilder {\n  private apis: ApiImpl[] = [];\n\n  add<T, I extends T>(api: ApiRef<T>, impl: I): I {\n    this.apis.push([api, impl]);\n    return impl;\n  }\n\n  build(): ApiRegistry {\n    // eslint-disable-next-line no-use-before-define\n    return new ApiRegistry(new Map(this.apis));\n  }\n}\n\nexport class ApiRegistry implements ApiHolder {\n  static builder() {\n    return new ApiRegistryBuilder();\n  }\n\n  static from(apis: ApiImpl[]) {\n    return new ApiRegistry(new Map(apis));\n  }\n\n  /**\n   * Creates a new ApiRegistry with a single API implementation.\n   *\n   * @param api ApiRef for the API to add\n   * @param impl Implementation of the API to add\n   */\n  static with<T>(api: ApiRef<T>, impl: T): ApiRegistry {\n    return new ApiRegistry(new Map([[api, impl]]));\n  }\n\n  constructor(private readonly apis: Map<ApiRef<unknown>, unknown>) {}\n\n  /**\n   * Returns a new ApiRegistry with the provided API added to the existing ones.\n   *\n   * @param api ApiRef for the API to add\n   * @param impl Implementation of the API to add\n   */\n  with<T>(api: ApiRef<T>, impl: T): ApiRegistry {\n    return new ApiRegistry(new Map([...this.apis, [api, impl]]));\n  }\n\n  get<T>(api: ApiRef<T>): T | undefined {\n    return this.apis.get(api) as T | undefined;\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport type ApiRefConfig = {\n  id: string;\n  description: string;\n};\n\nexport type ApiRef<T> = {\n  id: string;\n  description: string;\n  T: T;\n};\n\nclass ApiRefImpl<T> implements ApiRef<T> {\n  constructor(private readonly config: ApiRefConfig) {\n    const valid = config.id\n      .split('.')\n      .flatMap(part => part.split('-'))\n      .every(part => part.match(/^[a-z][a-z0-9]*$/));\n    if (!valid) {\n      throw new Error(\n        `API id must only contain period separated lowercase alphanum tokens with dashes, got '${config.id}'`,\n      );\n    }\n  }\n\n  get id(): string {\n    return this.config.id;\n  }\n\n  get description(): string {\n    return this.config.description;\n  }\n\n  // Utility for getting type of an api, using `typeof apiRef.T`\n  get T(): T {\n    throw new Error(`tried to read ApiRef.T of ${this}`);\n  }\n\n  toString() {\n    return `apiRef{${this.config.id}}`;\n  }\n}\n\nexport function createApiRef<T>(config: ApiRefConfig): ApiRef<T> {\n  return new ApiRefImpl<T>(config);\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ApiFactory, TypesToApiRefs } from './types';\nimport { ApiRef } from './ApiRef';\n\n/**\n * Used to infer types for a standalone ApiFactory that isn't immediately passed\n * to another function.\n * This function doesn't actually do anything, it's only used to infer types.\n */\nexport function createApiFactory<\n  Api,\n  Impl extends Api,\n  Deps extends { [name in string]: unknown }\n>(factory: ApiFactory<Api, Deps>): ApiFactory<Api, Deps>;\nexport function createApiFactory<Api>(\n  api: ApiRef<Api>,\n  instance: Api,\n): ApiFactory<Api, {}>;\nexport function createApiFactory<\n  Api,\n  Deps extends { [name in string]: unknown }\n>(\n  factory: ApiFactory<Api, Deps> | ApiRef<Api>,\n  instance?: Api,\n): ApiFactory<Api, Deps> {\n  if ('id' in factory) {\n    return {\n      api: factory,\n      deps: {} as TypesToApiRefs<Deps>,\n      factory: () => instance!,\n    };\n  }\n  return factory;\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createApiRef } from '../ApiRef';\nimport { Observable } from '../..';\n\n/**\n * This file contains declarations for common interfaces of auth-related APIs.\n * The declarations should be used to signal which type of authentication and\n * authorization methods each separate auth provider supports.\n *\n * For example, a Google OAuth provider that supports OAuth 2 and OpenID Connect,\n * would be declared as follows:\n *\n * const googleAuthApiRef = createApiRef<OAuthApi & OpenIDConnectApi>({ ... })\n */\n\n/**\n * An array of scopes, or a scope string formatted according to the\n * auth provider, which is typically a space separated list.\n *\n * See the documentation for each auth provider for the list of scopes\n * supported by each provider.\n */\nexport type OAuthScope = string | string[];\n\nexport type AuthRequestOptions = {\n  /**\n   * If this is set to true, the user will not be prompted to log in,\n   * and an empty response will be returned if there is no existing session.\n   *\n   * This can be used to perform a check whether the user is logged in, or if you don't\n   * want to force a user to be logged in, but provide functionality if they already are.\n   *\n   * @default false\n   */\n  optional?: boolean;\n\n  /**\n   * If this is set to true, the request will bypass the regular oauth login modal\n   * and open the login popup directly.\n   *\n   * The method must be called synchronously from a user action for this to work in all browsers.\n   *\n   * @default false\n   */\n  instantPopup?: boolean;\n};\n\n/**\n * This API provides access to OAuth 2 credentials. It lets you request access tokens,\n * which can be used to act on behalf of the user when talking to APIs.\n */\nexport type OAuthApi = {\n  /**\n   * Requests an OAuth 2 Access Token, optionally with a set of scopes. The access token allows\n   * you to make requests on behalf of the user, and the copes may grant you broader access, depending\n   * on the auth provider.\n   *\n   * Each auth provider has separate handling of scope, so you need to look at the documentation\n   * for each one to know what scope you need to request.\n   *\n   * This method is cheap and should be called each time an access token is used. Do not for example\n   * store the access token in React component state, as that could cause the token to expire. Instead\n   * fetch a new access token for each request.\n   *\n   * Be sure to include all required scopes when requesting an access token. When testing your implementation\n   * it is best to log out the Backstage session and then visit your plugin page directly, as\n   * you might already have some required scopes in your existing session. Not requesting the correct\n   * scopes can lead to 403 or other authorization errors, which can be tricky to debug.\n   *\n   * If the user has not yet granted access to the provider and the set of requested scopes, the user\n   * will be prompted to log in. The returned promise will not resolve until the user has\n   * successfully logged in. The returned promise can be rejected, but only if the user rejects the login request.\n   */\n  getAccessToken(\n    scope?: OAuthScope,\n    options?: AuthRequestOptions,\n  ): Promise<string>;\n};\n\n/**\n * This API provides access to OpenID Connect credentials. It lets you request ID tokens,\n * which can be passed to backend services to prove the user's identity.\n */\nexport type OpenIdConnectApi = {\n  /**\n   * Requests an OpenID Connect ID Token.\n   *\n   * This method is cheap and should be called each time an ID token is used. Do not for example\n   * store the id token in React component state, as that could cause the token to expire. Instead\n   * fetch a new id token for each request.\n   *\n   * If the user has not yet logged in to Google inside Backstage, the user will be prompted\n   * to log in. The returned promise will not resolve until the user has successfully logged in.\n   * The returned promise can be rejected, but only if the user rejects the login request.\n   */\n  getIdToken(options?: AuthRequestOptions): Promise<string>;\n};\n\n/**\n * This API provides access to profile information of the user from an auth provider.\n */\nexport type ProfileInfoApi = {\n  /**\n   * Get profile information for the user as supplied by this auth provider.\n   *\n   * If the optional flag is not set, a session is guaranteed to be returned, while if\n   * the optional flag is set, the session may be undefined. See @AuthRequestOptions for more details.\n   */\n  getProfile(options?: AuthRequestOptions): Promise<ProfileInfo | undefined>;\n};\n\n/**\n * This API provides access to the user's identity within Backstage.\n *\n * An auth provider that implements this interface can be used to sign-in to backstage. It is\n * not intended to be used directly from a plugin, but instead serves as a connection between\n * this authentication method and the app's @IdentityApi\n */\nexport type BackstageIdentityApi = {\n  /**\n   * Get the user's identity within Backstage. This should normally not be called directly,\n   * use the @IdentityApi instead.\n   *\n   * If the optional flag is not set, a session is guaranteed to be returned, while if\n   * the optional flag is set, the session may be undefined. See @AuthRequestOptions for more details.\n   */\n  getBackstageIdentity(\n    options?: AuthRequestOptions,\n  ): Promise<BackstageIdentity | undefined>;\n};\n\nexport type BackstageIdentity = {\n  /**\n   * The backstage user ID.\n   */\n  id: string;\n\n  /**\n   * An ID token that can be used to authenticate the user within Backstage.\n   */\n  idToken: string;\n};\n\n/**\n * Profile information of the user.\n */\nexport type ProfileInfo = {\n  /**\n   * Email ID.\n   */\n  email?: string;\n\n  /**\n   * Display name that can be presented to the user.\n   */\n  displayName?: string;\n\n  /**\n   * URL to an avatar image of the user.\n   */\n  picture?: string;\n};\n\n/**\n * Session state values passed to subscribers of the SessionApi.\n */\nexport enum SessionState {\n  SignedIn = 'SignedIn',\n  SignedOut = 'SignedOut',\n}\n\n/**\n * The SessionApi provides basic controls for any auth provider that is tied to a persistent session.\n */\nexport type SessionApi = {\n  /**\n   * Sign in with a minimum set of permissions.\n   */\n  signIn(): Promise<void>;\n\n  /**\n   * Sign out from the current session. This will reload the page.\n   */\n  signOut(): Promise<void>;\n\n  /**\n   * Observe the current state of the auth session. Emits the current state on subscription.\n   */\n  sessionState$(): Observable<SessionState>;\n};\n\n/**\n * Provides authentication towards Google APIs and identities.\n *\n * See https://developers.google.com/identity/protocols/googlescopes for a full list of supported scopes.\n *\n * Note that the ID token payload is only guaranteed to contain the user's numerical Google ID,\n * email and expiration information. Do not rely on any other fields, as they might not be present.\n */\nexport const googleAuthApiRef = createApiRef<\n  OAuthApi &\n    OpenIdConnectApi &\n    ProfileInfoApi &\n    BackstageIdentityApi &\n    SessionApi\n>({\n  id: 'core.auth.google',\n  description: 'Provides authentication towards Google APIs and identities',\n});\n\n/**\n * Provides authentication towards GitHub APIs.\n *\n * See https://developer.github.com/apps/building-oauth-apps/understanding-scopes-for-oauth-apps/\n * for a full list of supported scopes.\n */\nexport const githubAuthApiRef = createApiRef<\n  OAuthApi & ProfileInfoApi & BackstageIdentityApi & SessionApi\n>({\n  id: 'core.auth.github',\n  description: 'Provides authentication towards GitHub APIs',\n});\n\n/**\n * Provides authentication towards Okta APIs.\n *\n * See https://developer.okta.com/docs/guides/implement-oauth-for-okta/scopes/\n * for a full list of supported scopes.\n */\nexport const oktaAuthApiRef = createApiRef<\n  OAuthApi &\n    OpenIdConnectApi &\n    ProfileInfoApi &\n    BackstageIdentityApi &\n    SessionApi\n>({\n  id: 'core.auth.okta',\n  description: 'Provides authentication towards Okta APIs',\n});\n\n/**\n * Provides authentication towards GitLab APIs.\n *\n * See https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html#limiting-scopes-of-a-personal-access-token\n * for a full list of supported scopes.\n */\nexport const gitlabAuthApiRef = createApiRef<\n  OAuthApi & ProfileInfoApi & BackstageIdentityApi & SessionApi\n>({\n  id: 'core.auth.gitlab',\n  description: 'Provides authentication towards GitLab APIs',\n});\n\n/**\n * Provides authentication towards Auth0 APIs.\n *\n * See https://auth0.com/docs/scopes/current/oidc-scopes\n * for a full list of supported scopes.\n */\nexport const auth0AuthApiRef = createApiRef<\n  OpenIdConnectApi & ProfileInfoApi & BackstageIdentityApi & SessionApi\n>({\n  id: 'core.auth.auth0',\n  description: 'Provides authentication towards Auth0 APIs',\n});\n\n/**\n * Provides authentication towards Microsoft APIs and identities.\n *\n * For more info and a full list of supported scopes, see:\n * - https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-permissions-and-consent\n * - https://docs.microsoft.com/en-us/graph/permissions-reference\n */\nexport const microsoftAuthApiRef = createApiRef<\n  OAuthApi &\n    OpenIdConnectApi &\n    ProfileInfoApi &\n    BackstageIdentityApi &\n    SessionApi\n>({\n  id: 'core.auth.microsoft',\n  description: 'Provides authentication towards Microsoft APIs and identities',\n});\n\n/**\n * Provides authentication for custom identity providers.\n */\nexport const oauth2ApiRef = createApiRef<\n  OAuthApi &\n    OpenIdConnectApi &\n    ProfileInfoApi &\n    BackstageIdentityApi &\n    SessionApi\n>({\n  id: 'core.auth.oauth2',\n  description: 'Example of how to use oauth2 custom provider',\n});\n\n/**\n * Provides authentication for saml based identity providers\n */\nexport const samlAuthApiRef = createApiRef<\n  ProfileInfoApi & BackstageIdentityApi & SessionApi\n>({\n  id: 'core.auth.saml',\n  description: 'Example of how to use SAML custom provider',\n});\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { createApiRef } from '../ApiRef';\nimport { Observable } from '../../types';\n\nexport type AlertMessage = {\n  message: string;\n  // Severity will default to success since that is what material ui defaults the value to.\n  severity?: 'success' | 'info' | 'warning' | 'error';\n};\n\n/**\n * The alert API is used to report alerts to the app, and display them to the user.\n */\n\nexport type AlertApi = {\n  /**\n   * Post an alert for handling by the application.\n   */\n  post(alert: AlertMessage): void;\n\n  /**\n   * Observe alerts posted by other parts of the application.\n   */\n  alert$(): Observable<AlertMessage>;\n};\n\nexport const alertApiRef = createApiRef<AlertApi>({\n  id: 'core.alert',\n  description: 'Used to report alerts and forward them to the app',\n});\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createApiRef } from '../ApiRef';\nimport { BackstageTheme } from '@backstage/theme';\nimport { Observable } from '../../types';\nimport { SvgIconProps } from '@material-ui/core';\n\n/**\n * Describes a theme provided by the app.\n */\nexport type AppTheme = {\n  /**\n   * ID used to remember theme selections.\n   */\n  id: string;\n\n  /**\n   * Title of the theme\n   */\n  title: string;\n\n  /**\n   * Theme variant\n   */\n  variant: 'light' | 'dark';\n\n  /**\n   * The specialized MaterialUI theme instance.\n   */\n  theme: BackstageTheme;\n\n  /**\n   * An Icon for the theme mode setting.\n   */\n  icon?: React.ReactElement<SvgIconProps>;\n};\n\n/**\n * The AppThemeApi gives access to the current app theme, and allows switching\n * to other options that have been registered as a part of the App.\n */\nexport type AppThemeApi = {\n  /**\n   * Get a list of available themes.\n   */\n  getInstalledThemes(): AppTheme[];\n\n  /**\n   * Observe the currently selected theme. A value of undefined means no specific theme has been selected.\n   */\n  activeThemeId$(): Observable<string | undefined>;\n\n  /**\n   * Get the current theme ID. Returns undefined if no specific theme is selected.\n   */\n  getActiveThemeId(): string | undefined;\n\n  /**\n   * Set a specific theme to use in the app, overriding the default theme selection.\n   *\n   * Clear the selection by passing in undefined.\n   */\n  setActiveThemeId(themeId?: string): void;\n};\n\nexport const appThemeApiRef = createApiRef<AppThemeApi>({\n  id: 'core.apptheme',\n  description: 'API Used to configure the app theme, and enumerate options',\n});\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { createApiRef } from '../ApiRef';\nimport { Config } from '@backstage/config';\n\n// Using interface to make the ConfigApi name show up in docs\nexport type ConfigApi = Config;\n\nexport const configApiRef = createApiRef<ConfigApi>({\n  id: 'core.config',\n  description: 'Used to access runtime configuration',\n});\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createApiRef } from '../ApiRef';\nimport { Observable } from '../../types';\n\n/**\n * Mirrors the javascript Error class, for the purpose of\n * providing documentation and optional fields.\n */\ntype Error = {\n  name: string;\n  message: string;\n  stack?: string;\n};\n\n/**\n * Provides additional information about an error that was posted to the application.\n */\nexport type ErrorContext = {\n  // If set to true, this error should not be displayed to the user. Defaults to false.\n  hidden?: boolean;\n};\n\n/**\n * The error API is used to report errors to the app, and display them to the user.\n *\n * Plugins can use this API as a method of displaying errors to the user, but also\n * to report errors for collection by error reporting services.\n *\n * If an error can be displayed inline, e.g. as feedback in a form, that should be\n * preferred over relying on this API to display the error. The main use of this api\n * for displaying errors should be for asynchronous errors, such as a failing background process.\n *\n * Even if an error is displayed inline, it should still be reported through this api\n * if it would be useful to collect or log it for debugging purposes, but with\n * the hidden flag set. For example, an error arising from form field validation\n * should probably not be reported, while a failed REST call would be useful to report.\n */\nexport type ErrorApi = {\n  /**\n   * Post an error for handling by the application.\n   */\n  post(error: Error, context?: ErrorContext): void;\n\n  /**\n   * Observe errors posted by other parts of the application.\n   */\n  error$(): Observable<{ error: Error; context?: ErrorContext }>;\n};\n\nexport const errorApiRef = createApiRef<ErrorApi>({\n  id: 'core.error',\n  description: 'Used to report errors and forward them to the app',\n});\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createApiRef } from '../ApiRef';\nimport { UserFlags, FeatureFlagsRegistry } from '../../app/FeatureFlags';\nimport { FeatureFlagName } from '../../plugin';\n\n/**\n * The feature flags API is used to toggle functionality to users across plugins and Backstage.\n *\n * Plugins can use this API to register feature flags that they have available\n * for users to enable/disable, and this API will centralize the current user's\n * state of which feature flags they would like to enable.\n *\n * This is ideal for Backstage plugins, as well as your own App, to trial incomplete\n * or unstable upcoming features. Although there will be a common interface for users\n * to enable and disable feature flags, this API acts as another way to enable/disable.\n */\n\nexport enum FeatureFlagState {\n  Off = 0,\n  On = 1,\n}\n\nexport interface FeatureFlagsApi {\n  /**\n   * Store a list of registered feature flags.\n   */\n  registeredFeatureFlags: FeatureFlagsRegistryItem[];\n\n  /**\n   * Get a list of all feature flags from the current user.\n   */\n  getFlags(): UserFlags;\n\n  /**\n   * Get a list of all registered flags.\n   */\n  getRegisteredFlags(): FeatureFlagsRegistry;\n}\n\nexport interface FeatureFlagsRegistryItem {\n  pluginId: string;\n  name: FeatureFlagName;\n}\n\nexport const featureFlagsApiRef = createApiRef<FeatureFlagsApi>({\n  id: 'core.featureflags',\n  description: 'Used to toggle functionality in features across Backstage',\n});\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { createApiRef } from '../ApiRef';\n\n/**\n * The discovery API is used to provide a mechanism for plugins to\n * discover the endpoint to use to talk to their backend counterpart.\n *\n * The purpose of the discovery API is to allow for many different deployment\n * setups and routing methods through a central configuration, instead\n * of letting each individual plugin manage that configuration.\n *\n * Implementations of the discovery API can be a simple as a URL pattern\n * using the pluginId, but could also have overrides for individual plugins,\n * or query a separate discovery service.\n */\nexport type DiscoveryApi = {\n  /**\n   * Returns the HTTP base backend URL for a given plugin, without a trailing slash.\n   *\n   * This method must always be called just before making a request. as opposed to\n   * fetching the URL when constructing an API client. That is to ensure that more\n   * flexible routing patterns can be supported.\n   *\n   * For example, asking for the URL for `auth` may return something\n   * like `https://backstage.example.com/api/auth`\n   */\n  getBaseUrl(pluginId: string): Promise<string>;\n};\n\nexport const discoveryApiRef = createApiRef<DiscoveryApi>({\n  id: 'core.discovery',\n  description: 'Provides service discovery of backend plugins',\n});\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { createApiRef } from '../ApiRef';\nimport { ProfileInfo } from './auth';\n\n/**\n * The Identity API used to identify and get information about the signed in user.\n */\nexport type IdentityApi = {\n  /**\n   * The ID of the signed in user. This ID is not meant to be presented to the user, but used\n   * as an opaque string to pass on to backends or use in frontend logic.\n   *\n   * TODO: The intention of the user ID is to be able to tie the user to an identity\n   *       that is known by the catalog and/or identity backend. It should for example\n   *       be possible to fetch all owned components using this ID.\n   */\n  getUserId(): string;\n\n  /**\n   * The profile of the signed in user.\n   */\n  getProfile(): ProfileInfo;\n\n  /**\n   * An OpenID Connect ID Token which proves the identity of the signed in user.\n   *\n   * The ID token will be undefined if the signed in user does not have a verified\n   * identity, such as a demo user or mocked user for e2e tests.\n   */\n  getIdToken(): Promise<string | undefined>;\n\n  // TODO: getProfile(): Promise<Profile> - We want this to be async when added, but needs more work.\n\n  /**\n   * Sign out the current user\n   */\n  signOut(): Promise<void>;\n};\n\nexport const identityApiRef = createApiRef<IdentityApi>({\n  id: 'core.identity',\n  description: 'Provides access to the identity of the signed in user',\n});\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { IconComponent } from '../../icons';\nimport { Observable } from '../../types';\nimport { createApiRef } from '../ApiRef';\n\n/**\n * Information about the auth provider that we're requesting a login towards.\n *\n * This should be shown to the user so that they can be informed about what login is being requested\n * before a popup is shown.\n */\nexport type AuthProvider = {\n  /**\n   * Title for the auth provider, for example \"GitHub\"\n   */\n  title: string;\n\n  /**\n   * Icon for the auth provider.\n   */\n  icon: IconComponent;\n};\n\n/**\n * Describes how to handle auth requests. Both how to show them to the user, and what to do when\n * the user accesses the auth request.\n */\nexport type AuthRequesterOptions<AuthResponse> = {\n  /**\n   * Information about the auth provider, which will be forwarded to auth requests.\n   */\n  provider: AuthProvider;\n\n  /**\n   * Implementation of the auth flow, which will be called synchronously when\n   * trigger() is called on an auth requests.\n   */\n  onAuthRequest(scopes: Set<string>): Promise<AuthResponse>;\n};\n\n/**\n * Function used to trigger new auth requests for a set of scopes.\n *\n * The returned promise will resolve to the same value returned by the onAuthRequest in the\n * AuthRequesterOptions. Or rejected, if the request is rejected.\n *\n * This function can be called multiple times before the promise resolves. All calls\n * will be merged into one request, and the scopes forwarded to the onAuthRequest will be the\n * union of all requested scopes.\n */\nexport type AuthRequester<AuthResponse> = (\n  scopes: Set<string>,\n) => Promise<AuthResponse>;\n\n/**\n * An pending auth request for a single auth provider. The request will remain in this pending\n * state until either reject() or trigger() is called.\n *\n * Any new requests for the same provider are merged into the existing pending request, meaning\n * there will only ever be a single pending request for a given provider.\n */\nexport type PendingAuthRequest = {\n  /**\n   * Information about the auth provider, as given in the AuthRequesterOptions\n   */\n  provider: AuthProvider;\n\n  /**\n   * Rejects the request, causing all pending AuthRequester calls to fail with \"RejectedError\".\n   */\n  reject: () => void;\n\n  /**\n   * Trigger the auth request to continue the auth flow, by for example showing a popup.\n   *\n   * Synchronously calls onAuthRequest with all scope currently in the request.\n   */\n  trigger(): Promise<void>;\n};\n\n/**\n * Provides helpers for implemented OAuth login flows within Backstage.\n */\nexport type OAuthRequestApi = {\n  /**\n   * A utility for showing login popups or similar things, and merging together multiple requests for\n   * different scopes into one request that inclues all scopes.\n   *\n   * The passed in options provide information about the login provider, and how to handle auth requests.\n   *\n   * The returned AuthRequester function is used to request login with new scopes. These requests\n   * are merged together and forwarded to the auth handler, as soon as a consumer of auth requests\n   * triggers an auth flow.\n   *\n   * See AuthRequesterOptions, AuthRequester, and handleAuthRequests for more info.\n   */\n  createAuthRequester<AuthResponse>(\n    options: AuthRequesterOptions<AuthResponse>,\n  ): AuthRequester<AuthResponse>;\n\n  /**\n   * Observers panding auth requests. The returned observable will emit all\n   * current active auth request, at most one for each created auth requester.\n   *\n   * Each request has its own info about the login provider, forwarded from the auth requester options.\n   *\n   * Depending on user interaction, the request should either be rejected, or used to trigger the auth handler.\n   * If the request is rejected, all pending AuthRequester calls will fail with a \"RejectedError\".\n   * If a auth is triggered, and the auth handler resolves successfully, then all currently pending\n   * AuthRequester calls will resolve to the value returned by the onAuthRequest call.\n   */\n  authRequest$(): Observable<PendingAuthRequest[]>;\n};\n\nexport const oauthRequestApiRef = createApiRef<OAuthRequestApi>({\n  id: 'core.oauthrequest',\n  description: 'An API for implementing unified OAuth flows in Backstage',\n});\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createApiRef } from '../ApiRef';\nimport { Observable } from '../../types';\nimport { ErrorApi } from './ErrorApi';\n\nexport type StorageValueChange<T = any> = {\n  key: string;\n  newValue?: T;\n};\n\nexport type CreateStorageApiOptions = {\n  errorApi: ErrorApi;\n  namespace?: string;\n};\n\nexport interface StorageApi {\n  /**\n   * Create a bucket to store data in.\n   * @param {String} name Namespace for the storage to be stored under,\n   *                      will inherit previous namespaces too\n   */\n  forBucket(name: string): StorageApi;\n\n  /**\n   * Get the current value for persistent data, use observe$ to be notified of updates.\n   *\n   * @param {String} key Unique key associated with the data.\n   * @return {Object} data The data that should is stored.\n   */\n  get<T>(key: string): T | undefined;\n\n  /**\n   * Remove persistent data.\n   *\n   * @param {String} key Unique key associated with the data.\n   */\n  remove(key: string): Promise<void>;\n\n  /**\n   * Save persistant data, and emit messages to anyone that is using observe$ for this key\n   *\n   * @param {String} key Unique key associated with the data.\n   */\n  set(key: string, data: any): Promise<void>;\n\n  /**\n   * Observe changes on a particular key in the bucket\n   * @param {String} key Unique key associated with the data\n   */\n  observe$<T>(key: string): Observable<StorageValueChange<T>>;\n}\n\nexport const storageApiRef = createApiRef<StorageApi>({\n  id: 'core.storage',\n  description: 'Provides the ability to store data which is unique to the user',\n});\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Options used to open a login popup.\n */\nexport type LoginPopupOptions = {\n  /**\n   * The URL that the auth popup should point to\n   */\n  url: string;\n\n  /**\n   * The name of the popup, as in second argument to window.open\n   */\n  name: string;\n\n  /**\n   * The origin of the final popup page that will post a message to this window.\n   */\n  origin: string;\n\n  /**\n   * The width of the popup in pixels, defaults to 500\n   */\n  width?: number;\n\n  /**\n   * The height of the popup in pixels, defaults to 700\n   */\n  height?: number;\n};\n\ntype AuthResult =\n  | {\n      type: 'authorization_response';\n      response: unknown;\n    }\n  | {\n      type: 'authorization_response';\n      error: {\n        name: string;\n        message: string;\n      };\n    };\n\n/**\n * Show a popup pointing to a URL that starts an auth flow. Implementing the receiving\n * end of the postMessage mechanism outlined in https://tools.ietf.org/html/draft-sakimura-oauth-wmrm-00\n *\n * The redirect handler of the flow should use postMessage to communicate back\n * to the app window. The message posted to the app must match the AuthResult type.\n *\n * The returned promise resolves to the response of the message that was posted from the auth popup.\n */\nexport function showLoginPopup(options: LoginPopupOptions): Promise<any> {\n  return new Promise((resolve, reject) => {\n    const width = options.width || 500;\n    const height = options.height || 700;\n    const left = window.screen.width / 2 - width / 2;\n    const top = window.screen.height / 2 - height / 2;\n\n    const popup = window.open(\n      options.url,\n      options.name,\n      `menubar=no,location=no,resizable=no,scrollbars=no,status=no,width=${width},height=${height},top=${top},left=${left}`,\n    );\n\n    if (!popup || typeof popup.closed === 'undefined' || popup.closed) {\n      reject(new Error('Failed to open auth popup.'));\n      return;\n    }\n\n    const messageListener = (event: MessageEvent) => {\n      if (event.source !== popup) {\n        return;\n      }\n      if (event.origin !== options.origin) {\n        return;\n      }\n      const { data } = event;\n      if (data.type !== 'authorization_response') {\n        return;\n      }\n      const authResult = data as AuthResult;\n\n      if ('error' in authResult) {\n        const error = new Error(authResult.error.message);\n        error.name = authResult.error.name;\n        // TODO: proper error type\n        // error.extra = authResult.error.extra;\n        reject(error);\n      } else {\n        resolve(authResult.response);\n      }\n      done();\n    };\n\n    const intervalId = setInterval(() => {\n      if (popup.closed) {\n        const error = new Error('Login failed, popup was closed');\n        error.name = 'PopupClosedError';\n        reject(error);\n        done();\n      }\n    }, 100);\n\n    function done() {\n      window.removeEventListener('message', messageListener);\n      clearInterval(intervalId);\n    }\n\n    window.addEventListener('message', messageListener);\n  });\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AuthRequester } from '../../apis';\nimport {\n  OAuthRequestApi,\n  AuthProvider,\n  DiscoveryApi,\n} from '../../apis/definitions';\nimport { showLoginPopup } from '../loginPopup';\nimport { AuthConnector, CreateSessionOptions } from './types';\n\ntype Options<AuthSession> = {\n  /**\n   * DiscoveryApi instance used to locate the auth backend endpoint.\n   */\n  discoveryApi: DiscoveryApi;\n  /**\n   * Environment hint passed on to auth backend, for example 'production' or 'development'\n   */\n  environment: string;\n  /**\n   * Information about the auth provider to be shown to the user.\n   * The ID Must match the backend auth plugin configuration, for example 'google'.\n   */\n  provider: AuthProvider & { id: string };\n  /**\n   * API used to instantiate an auth requester.\n   */\n  oauthRequestApi: OAuthRequestApi;\n  /**\n   * Function used to join together a set of scopes, defaults to joining with a space character.\n   */\n  joinScopes?: (scopes: Set<string>) => string;\n  /**\n   * Function used to transform an auth response into the session type.\n   */\n  sessionTransform?(response: any): AuthSession | Promise<AuthSession>;\n};\n\nfunction defaultJoinScopes(scopes: Set<string>) {\n  return [...scopes].join(' ');\n}\n\n/**\n * DefaultAuthConnector is the default auth connector in Backstage. It talks to the\n * backend auth plugin through the standardized API, and requests user permission\n * via the OAuthRequestApi.\n */\nexport class DefaultAuthConnector<AuthSession>\n  implements AuthConnector<AuthSession> {\n  private readonly discoveryApi: DiscoveryApi;\n  private readonly environment: string;\n  private readonly provider: AuthProvider & { id: string };\n  private readonly joinScopesFunc: (scopes: Set<string>) => string;\n  private readonly authRequester: AuthRequester<AuthSession>;\n  private readonly sessionTransform: (response: any) => Promise<AuthSession>;\n\n  constructor(options: Options<AuthSession>) {\n    const {\n      discoveryApi,\n      environment,\n      provider,\n      joinScopes = defaultJoinScopes,\n      oauthRequestApi,\n      sessionTransform = id => id,\n    } = options;\n\n    this.authRequester = oauthRequestApi.createAuthRequester({\n      provider,\n      onAuthRequest: scopes => this.showPopup(scopes),\n    });\n\n    this.discoveryApi = discoveryApi;\n    this.environment = environment;\n    this.provider = provider;\n    this.joinScopesFunc = joinScopes;\n    this.sessionTransform = sessionTransform;\n  }\n\n  async createSession(options: CreateSessionOptions): Promise<AuthSession> {\n    if (options.instantPopup) {\n      return this.showPopup(options.scopes);\n    }\n    return this.authRequester(options.scopes);\n  }\n\n  async refreshSession(): Promise<any> {\n    const res = await fetch(\n      await this.buildUrl('/refresh', { optional: true }),\n      {\n        headers: {\n          'x-requested-with': 'XMLHttpRequest',\n        },\n        credentials: 'include',\n      },\n    ).catch(error => {\n      throw new Error(`Auth refresh request failed, ${error}`);\n    });\n\n    if (!res.ok) {\n      const error: any = new Error(\n        `Auth refresh request failed, ${res.statusText}`,\n      );\n      error.status = res.status;\n      throw error;\n    }\n\n    const authInfo = await res.json();\n\n    if (authInfo.error) {\n      const error = new Error(authInfo.error.message);\n      if (authInfo.error.name) {\n        error.name = authInfo.error.name;\n      }\n      throw error;\n    }\n    return await this.sessionTransform(authInfo);\n  }\n\n  async removeSession(): Promise<void> {\n    const res = await fetch(await this.buildUrl('/logout'), {\n      method: 'POST',\n      headers: {\n        'x-requested-with': 'XMLHttpRequest',\n      },\n      credentials: 'include',\n    }).catch(error => {\n      throw new Error(`Logout request failed, ${error}`);\n    });\n\n    if (!res.ok) {\n      const error: any = new Error(`Logout request failed, ${res.statusText}`);\n      error.status = res.status;\n      throw error;\n    }\n  }\n\n  private async showPopup(scopes: Set<string>): Promise<AuthSession> {\n    const scope = this.joinScopesFunc(scopes);\n    const popupUrl = await this.buildUrl('/start', { scope });\n\n    const payload = await showLoginPopup({\n      url: popupUrl,\n      name: `${this.provider.title} Login`,\n      origin: new URL(popupUrl).origin,\n      width: 450,\n      height: 730,\n    });\n\n    return await this.sessionTransform(payload);\n  }\n\n  private async buildUrl(\n    path: string,\n    query?: { [key: string]: string | boolean | undefined },\n  ): Promise<string> {\n    const baseUrl = await this.discoveryApi.getBaseUrl('auth');\n    const queryString = this.buildQueryString({\n      ...query,\n      env: this.environment,\n    });\n\n    return `${baseUrl}/${this.provider.id}${path}${queryString}`;\n  }\n\n  private buildQueryString(query?: {\n    [key: string]: string | boolean | undefined;\n  }): string {\n    if (!query) {\n      return '';\n    }\n\n    const queryString = Object.entries<string | boolean | undefined>(query)\n      .map(([key, value]) => {\n        if (typeof value === 'string') {\n          return `${encodeURIComponent(key)}=${encodeURIComponent(value)}`;\n        } else if (value) {\n          return encodeURIComponent(key);\n        }\n        return undefined;\n      })\n      .filter(Boolean)\n      .join('&');\n\n    if (!queryString) {\n      return '';\n    }\n    return `?${queryString}`;\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  AuthProvider,\n  ProfileInfo,\n  BackstageIdentity,\n  DiscoveryApi,\n} from '../../apis/definitions';\nimport { showLoginPopup } from '../loginPopup';\n\ntype Options = {\n  discoveryApi: DiscoveryApi;\n  environment?: string;\n  provider: AuthProvider & { id: string };\n};\n\nexport type DirectAuthResponse = {\n  userId: string;\n  profile: ProfileInfo;\n  backstageIdentity: BackstageIdentity;\n};\n\nexport class DirectAuthConnector<DirectAuthResponse> {\n  private readonly discoveryApi: DiscoveryApi;\n  private readonly environment: string | undefined;\n  private readonly provider: AuthProvider & { id: string };\n\n  constructor(options: Options) {\n    const { discoveryApi, environment, provider } = options;\n\n    this.discoveryApi = discoveryApi;\n    this.environment = environment;\n    this.provider = provider;\n  }\n\n  async createSession(): Promise<DirectAuthResponse> {\n    const popupUrl = await this.buildUrl('/start');\n    const payload = await showLoginPopup({\n      url: popupUrl,\n      name: `${this.provider.title} Login`,\n      origin: new URL(popupUrl).origin,\n      width: 450,\n      height: 730,\n    });\n\n    return {\n      ...payload,\n      id: payload.profile.email,\n    };\n  }\n\n  async refreshSession(): Promise<any> {}\n\n  async removeSession(): Promise<void> {\n    const res = await fetch(await this.buildUrl('/logout'), {\n      method: 'POST',\n      headers: {\n        'x-requested-with': 'XMLHttpRequest',\n      },\n      credentials: 'include',\n    }).catch(error => {\n      throw new Error(`Logout request failed, ${error}`);\n    });\n\n    if (!res.ok) {\n      const error: any = new Error(`Logout request failed, ${res.statusText}`);\n      error.status = res.status;\n      throw error;\n    }\n  }\n\n  private async buildUrl(path: string): Promise<string> {\n    const baseUrl = await this.discoveryApi.getBaseUrl('auth');\n    return `${baseUrl}/${this.provider.id}${path}?env=${this.environment}`;\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { SessionScopesFunc } from './types';\n\nexport function hasScopes(\n  searched: Set<string>,\n  searchFor: Set<string>,\n): boolean {\n  for (const scope of searchFor) {\n    if (!searched.has(scope)) {\n      return false;\n    }\n  }\n  return true;\n}\n\ntype ScopeHelperOptions<T> = {\n  sessionScopes: SessionScopesFunc<T> | undefined;\n  defaultScopes?: Set<string>;\n};\n\nexport class SessionScopeHelper<T> {\n  constructor(private readonly options: ScopeHelperOptions<T>) {}\n\n  sessionExistsAndHasScope(\n    session: T | undefined,\n    scopes?: Set<string>,\n  ): boolean {\n    if (!session) {\n      return false;\n    }\n    if (!scopes) {\n      return true;\n    }\n    if (this.options.sessionScopes === undefined) {\n      return true;\n    }\n    const sessionScopes = this.options.sessionScopes(session);\n    return hasScopes(sessionScopes, scopes);\n  }\n\n  getExtendedScope(session: T | undefined, scopes?: Set<string>) {\n    const newScope = new Set(this.options.defaultScopes);\n    if (session && this.options.sessionScopes !== undefined) {\n      const sessionScopes = this.options.sessionScopes(session);\n      for (const scope of sessionScopes) {\n        newScope.add(scope);\n      }\n    }\n    if (scopes) {\n      for (const scope of scopes) {\n        newScope.add(scope);\n      }\n    }\n    return newScope;\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Observable } from '../types';\nimport ObservableImpl from 'zen-observable';\n\n// TODO(Rugvip): These are stopgap and probably incomplete implementations of subjects.\n// If we add a more complete Observables library they should be replaced.\n\n/**\n * A basic implementation of ReactiveX publish subjects.\n *\n * A subject is a convenient way to create an observable when you want\n * to fan out a single value to all subscribers.\n *\n * See http://reactivex.io/documentation/subject.html\n */\nexport class PublishSubject<T>\n  implements Observable<T>, ZenObservable.SubscriptionObserver<T> {\n  private isClosed = false;\n  private terminatingError?: Error;\n\n  private readonly observable = new ObservableImpl<T>(subscriber => {\n    if (this.isClosed) {\n      if (this.terminatingError) {\n        subscriber.error(this.terminatingError);\n      } else {\n        subscriber.complete();\n      }\n      return () => {};\n    }\n\n    this.subscribers.add(subscriber);\n    return () => {\n      this.subscribers.delete(subscriber);\n    };\n  });\n\n  private readonly subscribers = new Set<\n    ZenObservable.SubscriptionObserver<T>\n  >();\n\n  get closed() {\n    return this.isClosed;\n  }\n\n  next(value: T) {\n    if (this.isClosed) {\n      throw new Error('PublishSubject is closed');\n    }\n    this.subscribers.forEach(subscriber => subscriber.next(value));\n  }\n\n  error(error: Error) {\n    if (this.isClosed) {\n      throw new Error('PublishSubject is closed');\n    }\n    this.isClosed = true;\n    this.terminatingError = error;\n    this.subscribers.forEach(subscriber => subscriber.error(error));\n  }\n\n  complete() {\n    if (this.isClosed) {\n      throw new Error('PublishSubject is closed');\n    }\n    this.isClosed = true;\n    this.subscribers.forEach(subscriber => subscriber.complete());\n  }\n\n  subscribe(observer: ZenObservable.Observer<T>): ZenObservable.Subscription;\n  subscribe(\n    onNext: (value: T) => void,\n    onError?: (error: any) => void,\n    onComplete?: () => void,\n  ): ZenObservable.Subscription;\n  subscribe(\n    onNext: ZenObservable.Observer<T> | ((value: T) => void),\n    onError?: (error: any) => void,\n    onComplete?: () => void,\n  ): ZenObservable.Subscription {\n    const observer =\n      typeof onNext === 'function'\n        ? {\n            next: onNext,\n            error: onError,\n            complete: onComplete,\n          }\n        : onNext;\n\n    return this.observable.subscribe(observer);\n  }\n}\n\n/**\n * A basic implementation of ReactiveX behavior subjects.\n *\n * A subject is a convenient way to create an observable when you want\n * to fan out a single value to all subscribers.\n *\n * The BehaviorSubject will emit the most recently emitted value or error\n * whenever a new observer subscribes to the subject.\n *\n * See http://reactivex.io/documentation/subject.html\n */\nexport class BehaviorSubject<T>\n  implements Observable<T>, ZenObservable.SubscriptionObserver<T> {\n  private isClosed = false;\n  private currentValue: T;\n  private terminatingError?: Error;\n\n  constructor(value: T) {\n    this.currentValue = value;\n  }\n\n  private readonly observable = new ObservableImpl<T>(subscriber => {\n    if (this.isClosed) {\n      if (this.terminatingError) {\n        subscriber.error(this.terminatingError);\n      } else {\n        subscriber.complete();\n      }\n      return () => {};\n    }\n\n    subscriber.next(this.currentValue);\n\n    this.subscribers.add(subscriber);\n    return () => {\n      this.subscribers.delete(subscriber);\n    };\n  });\n\n  private readonly subscribers = new Set<\n    ZenObservable.SubscriptionObserver<T>\n  >();\n\n  get closed() {\n    return this.isClosed;\n  }\n\n  next(value: T) {\n    if (this.isClosed) {\n      throw new Error('BehaviorSubject is closed');\n    }\n    this.currentValue = value;\n    this.subscribers.forEach(subscriber => subscriber.next(value));\n  }\n\n  error(error: Error) {\n    if (this.isClosed) {\n      throw new Error('BehaviorSubject is closed');\n    }\n    this.isClosed = true;\n    this.terminatingError = error;\n    this.subscribers.forEach(subscriber => subscriber.error(error));\n  }\n\n  complete() {\n    if (this.isClosed) {\n      throw new Error('BehaviorSubject is closed');\n    }\n    this.isClosed = true;\n    this.subscribers.forEach(subscriber => subscriber.complete());\n  }\n\n  subscribe(observer: ZenObservable.Observer<T>): ZenObservable.Subscription;\n  subscribe(\n    onNext: (value: T) => void,\n    onError?: (error: any) => void,\n    onComplete?: () => void,\n  ): ZenObservable.Subscription;\n  subscribe(\n    onNext: ZenObservable.Observer<T> | ((value: T) => void),\n    onError?: (error: any) => void,\n    onComplete?: () => void,\n  ): ZenObservable.Subscription {\n    const observer =\n      typeof onNext === 'function'\n        ? {\n            next: onNext,\n            error: onError,\n            complete: onComplete,\n          }\n        : onNext;\n\n    return this.observable.subscribe(observer);\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { BehaviorSubject } from '..';\nimport { SessionState } from '../../apis';\nimport { Observable } from '../../types';\n\nexport class SessionStateTracker {\n  private readonly subject = new BehaviorSubject<SessionState>(\n    SessionState.SignedOut,\n  );\n\n  private signedIn: boolean = false;\n\n  setIsSignedIn(isSignedIn: boolean) {\n    if (this.signedIn !== isSignedIn) {\n      this.signedIn = isSignedIn;\n      this.subject.next(\n        this.signedIn ? SessionState.SignedIn : SessionState.SignedOut,\n      );\n    }\n  }\n\n  sessionState$(): Observable<SessionState> {\n    return this.subject;\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  SessionManager,\n  SessionScopesFunc,\n  SessionShouldRefreshFunc,\n  GetSessionOptions,\n} from './types';\nimport { AuthConnector } from '../AuthConnector';\nimport { SessionScopeHelper, hasScopes } from './common';\nimport { SessionStateTracker } from './SessionStateTracker';\n\ntype Options<T> = {\n  /** The connector used for acting on the auth session */\n  connector: AuthConnector<T>;\n  /** Used to get the scope of the session */\n  sessionScopes: SessionScopesFunc<T>;\n  /** Used to check if the session needs to be refreshed */\n  sessionShouldRefresh: SessionShouldRefreshFunc<T>;\n  /** The default scopes that should always be present in a session, defaults to none. */\n  defaultScopes?: Set<string>;\n};\n\n/**\n * RefreshingAuthSessionManager manages an underlying session that has\n * and expiration time and needs to be refreshed periodically.\n */\nexport class RefreshingAuthSessionManager<T> implements SessionManager<T> {\n  private readonly connector: AuthConnector<T>;\n  private readonly helper: SessionScopeHelper<T>;\n  private readonly sessionScopesFunc: SessionScopesFunc<T>;\n  private readonly sessionShouldRefreshFunc: SessionShouldRefreshFunc<T>;\n  private readonly stateTracker = new SessionStateTracker();\n\n  private refreshPromise?: Promise<T>;\n  private currentSession: T | undefined;\n\n  constructor(options: Options<T>) {\n    const {\n      connector,\n      defaultScopes = new Set(),\n      sessionScopes,\n      sessionShouldRefresh,\n    } = options;\n\n    this.connector = connector;\n    this.sessionScopesFunc = sessionScopes;\n    this.sessionShouldRefreshFunc = sessionShouldRefresh;\n    this.helper = new SessionScopeHelper({ sessionScopes, defaultScopes });\n  }\n\n  async getSession(options: GetSessionOptions): Promise<T | undefined> {\n    if (\n      this.helper.sessionExistsAndHasScope(this.currentSession, options.scopes)\n    ) {\n      const shouldRefresh = this.sessionShouldRefreshFunc(this.currentSession!);\n      if (!shouldRefresh) {\n        return this.currentSession!;\n      }\n\n      try {\n        const refreshedSession = await this.collapsedSessionRefresh();\n        const currentScopes = this.sessionScopesFunc(this.currentSession!);\n        const refreshedScopes = this.sessionScopesFunc(refreshedSession);\n        if (hasScopes(refreshedScopes, currentScopes)) {\n          this.currentSession = refreshedSession;\n        }\n        return refreshedSession;\n      } catch (error) {\n        if (options.optional) {\n          return undefined;\n        }\n        throw error;\n      }\n    }\n\n    // The user may still have a valid refresh token in their cookies. Attempt to\n    // initiate a fresh session through the backend using that refresh token.\n    //\n    // We skip this check if an instant login popup is requested, as we need to\n    // stay in a synchronous call stack from the user interaction. The downside\n    // is that that the user will sometimes be requested to log in even if they\n    // already had an existing session.\n    if (!this.currentSession && !options.instantPopup) {\n      try {\n        const newSession = await this.collapsedSessionRefresh();\n        this.currentSession = newSession;\n        // The session might not have the scopes requested so go back and check again\n        return this.getSession(options);\n      } catch {\n        // If the refresh attempt fails we assume we don't have a session, so continue to create one.\n      }\n    }\n\n    // If we continue here we will show a popup, so exit if this is an optional session request.\n    if (options.optional) {\n      return undefined;\n    }\n\n    // We can call authRequester multiple times, the returned session will contain all requested scopes.\n    this.currentSession = await this.connector.createSession({\n      ...options,\n      scopes: this.helper.getExtendedScope(this.currentSession, options.scopes),\n    });\n    this.stateTracker.setIsSignedIn(true);\n    return this.currentSession;\n  }\n\n  async removeSession() {\n    this.currentSession = undefined;\n    await this.connector.removeSession();\n    this.stateTracker.setIsSignedIn(false);\n  }\n\n  sessionState$() {\n    return this.stateTracker.sessionState$();\n  }\n\n  private async collapsedSessionRefresh(): Promise<T> {\n    if (this.refreshPromise) {\n      return this.refreshPromise;\n    }\n\n    this.refreshPromise = this.connector.refreshSession();\n\n    try {\n      const session = await this.refreshPromise;\n      this.stateTracker.setIsSignedIn(true);\n      return session;\n    } finally {\n      delete this.refreshPromise;\n    }\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { SessionManager, GetSessionOptions } from './types';\nimport { AuthConnector } from '../AuthConnector';\nimport { SessionScopeHelper } from './common';\nimport { SessionStateTracker } from './SessionStateTracker';\n\ntype Options<T> = {\n  /** The connector used for acting on the auth session */\n  connector: AuthConnector<T>;\n  /** Used to get the scope of the session */\n  sessionScopes?: (session: T) => Set<string>;\n  /** The default scopes that should always be present in a session, defaults to none. */\n  defaultScopes?: Set<string>;\n};\n\n/**\n * StaticAuthSessionManager manages an underlying session that does not expire.\n */\nexport class StaticAuthSessionManager<T> implements SessionManager<T> {\n  private readonly connector: AuthConnector<T>;\n  private readonly helper: SessionScopeHelper<T>;\n  private readonly stateTracker = new SessionStateTracker();\n\n  private currentSession: T | undefined;\n\n  constructor(options: Options<T>) {\n    const { connector, defaultScopes = new Set(), sessionScopes } = options;\n\n    this.connector = connector;\n    this.helper = new SessionScopeHelper({ sessionScopes, defaultScopes });\n  }\n\n  async getSession(options: GetSessionOptions): Promise<T | undefined> {\n    if (\n      this.helper.sessionExistsAndHasScope(this.currentSession, options.scopes)\n    ) {\n      return this.currentSession;\n    }\n\n    // If we continue here we will show a popup, so exit if this is an optional session request.\n    if (options.optional) {\n      return undefined;\n    }\n\n    // We can call authRequester multiple times, the returned session will contain all requested scopes.\n    this.currentSession = await this.connector.createSession({\n      ...options,\n      scopes: this.helper.getExtendedScope(this.currentSession, options.scopes),\n    });\n    this.stateTracker.setIsSignedIn(true);\n    return this.currentSession;\n  }\n\n  async removeSession() {\n    this.currentSession = undefined;\n    await this.connector.removeSession();\n    this.stateTracker.setIsSignedIn(false);\n  }\n\n  sessionState$() {\n    return this.stateTracker.sessionState$();\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  SessionManager,\n  SessionScopesFunc,\n  SessionShouldRefreshFunc,\n  GetSessionOptions,\n} from './types';\nimport { SessionScopeHelper } from './common';\n\ntype Options<T> = {\n  /** The connector used for acting on the auth session */\n  manager: SessionManager<T>;\n  /** Storage key to use to store sessions */\n  storageKey: string;\n  /** Used to get the scope of the session */\n  sessionScopes?: SessionScopesFunc<T>;\n  /** Used to check if the session needs to be refreshed, defaults to never refresh */\n  sessionShouldRefresh?: SessionShouldRefreshFunc<T>;\n};\n\n/**\n * AuthSessionStore decorates another SessionManager with a functionality\n * to store the session in local storage.\n *\n * Session is serialized to JSON with special support for following types: Set.\n */\nexport class AuthSessionStore<T> implements SessionManager<T> {\n  private readonly manager: SessionManager<T>;\n  private readonly storageKey: string;\n  private readonly sessionShouldRefreshFunc: SessionShouldRefreshFunc<T>;\n  private readonly helper: SessionScopeHelper<T>;\n\n  constructor(options: Options<T>) {\n    const {\n      manager,\n      storageKey,\n      sessionScopes,\n      sessionShouldRefresh = () => false,\n    } = options;\n\n    this.manager = manager;\n    this.storageKey = storageKey;\n    this.sessionShouldRefreshFunc = sessionShouldRefresh;\n    this.helper = new SessionScopeHelper({\n      sessionScopes,\n      defaultScopes: new Set(),\n    });\n  }\n\n  async getSession(options: GetSessionOptions): Promise<T | undefined> {\n    const { scopes } = options;\n    const session = this.loadSession();\n\n    if (this.helper.sessionExistsAndHasScope(session, scopes)) {\n      const shouldRefresh = this.sessionShouldRefreshFunc(session!);\n\n      if (!shouldRefresh) {\n        return session!;\n      }\n    }\n\n    const newSession = await this.manager.getSession(options);\n    this.saveSession(newSession);\n    return newSession;\n  }\n\n  async removeSession() {\n    localStorage.removeItem(this.storageKey);\n    await this.manager.removeSession();\n  }\n\n  sessionState$() {\n    return this.manager.sessionState$();\n  }\n\n  private loadSession(): T | undefined {\n    try {\n      const sessionJson = localStorage.getItem(this.storageKey);\n      if (sessionJson) {\n        const session = JSON.parse(sessionJson, (_key, value) => {\n          if (value?.__type === 'Set') {\n            return new Set(value.__value);\n          }\n          return value;\n        });\n        return session;\n      }\n\n      return undefined;\n    } catch (error) {\n      localStorage.removeItem(this.storageKey);\n      return undefined;\n    }\n  }\n\n  private saveSession(session: T | undefined) {\n    if (session === undefined) {\n      localStorage.removeItem(this.storageKey);\n    } else {\n      localStorage.setItem(\n        this.storageKey,\n        JSON.stringify(session, (_key, value) => {\n          if (value instanceof Set) {\n            return {\n              __type: 'Set',\n              __value: Array.from(value),\n            };\n          }\n          return value;\n        }),\n      );\n    }\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport GithubIcon from '@material-ui/icons/AcUnit';\nimport { DefaultAuthConnector } from '../../../../lib/AuthConnector';\nimport { GithubSession } from './types';\nimport {\n  OAuthApi,\n  SessionApi,\n  SessionState,\n  ProfileInfo,\n  BackstageIdentity,\n  AuthRequestOptions,\n} from '../../../definitions/auth';\nimport {\n  OAuthRequestApi,\n  AuthProvider,\n  DiscoveryApi,\n} from '../../../definitions';\nimport { SessionManager } from '../../../../lib/AuthSessionManager/types';\nimport {\n  AuthSessionStore,\n  StaticAuthSessionManager,\n} from '../../../../lib/AuthSessionManager';\nimport { Observable } from '../../../../types';\n\ntype CreateOptions = {\n  discoveryApi: DiscoveryApi;\n  oauthRequestApi: OAuthRequestApi;\n\n  environment?: string;\n  provider?: AuthProvider & { id: string };\n};\n\nexport type GithubAuthResponse = {\n  providerInfo: {\n    accessToken: string;\n    scope: string;\n    expiresInSeconds: number;\n  };\n  profile: ProfileInfo;\n  backstageIdentity: BackstageIdentity;\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'github',\n  title: 'Github',\n  icon: GithubIcon,\n};\n\nclass GithubAuth implements OAuthApi, SessionApi {\n  static create({\n    discoveryApi,\n    environment = 'development',\n    provider = DEFAULT_PROVIDER,\n    oauthRequestApi,\n  }: CreateOptions) {\n    const connector = new DefaultAuthConnector({\n      discoveryApi,\n      environment,\n      provider,\n      oauthRequestApi: oauthRequestApi,\n      sessionTransform(res: GithubAuthResponse): GithubSession {\n        return {\n          ...res,\n          providerInfo: {\n            accessToken: res.providerInfo.accessToken,\n            scopes: GithubAuth.normalizeScope(res.providerInfo.scope),\n            expiresAt: new Date(\n              Date.now() + res.providerInfo.expiresInSeconds * 1000,\n            ),\n          },\n        };\n      },\n    });\n\n    const sessionManager = new StaticAuthSessionManager({\n      connector,\n      defaultScopes: new Set(['read:user']),\n      sessionScopes: (session: GithubSession) => session.providerInfo.scopes,\n    });\n\n    const authSessionStore = new AuthSessionStore<GithubSession>({\n      manager: sessionManager,\n      storageKey: 'githubSession',\n      sessionScopes: (session: GithubSession) => session.providerInfo.scopes,\n    });\n\n    return new GithubAuth(authSessionStore);\n  }\n\n  constructor(private readonly sessionManager: SessionManager<GithubSession>) {}\n\n  async signIn() {\n    await this.getAccessToken();\n  }\n\n  async signOut() {\n    await this.sessionManager.removeSession();\n  }\n\n  sessionState$(): Observable<SessionState> {\n    return this.sessionManager.sessionState$();\n  }\n\n  async getAccessToken(scope?: string, options?: AuthRequestOptions) {\n    const session = await this.sessionManager.getSession({\n      ...options,\n      scopes: GithubAuth.normalizeScope(scope),\n    });\n    return session?.providerInfo.accessToken ?? '';\n  }\n\n  async getBackstageIdentity(\n    options: AuthRequestOptions = {},\n  ): Promise<BackstageIdentity | undefined> {\n    const session = await this.sessionManager.getSession(options);\n    return session?.backstageIdentity;\n  }\n\n  async getProfile(options: AuthRequestOptions = {}) {\n    const session = await this.sessionManager.getSession(options);\n    return session?.profile;\n  }\n\n  static normalizeScope(scope?: string): Set<string> {\n    if (!scope) {\n      return new Set();\n    }\n\n    const scopeList = Array.isArray(scope)\n      ? scope\n      : scope.split(/[\\s|,]/).filter(Boolean);\n\n    return new Set(scopeList);\n  }\n}\nexport default GithubAuth;\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport OAuth2Icon from '@material-ui/icons/AcUnit';\nimport { DefaultAuthConnector } from '../../../../lib/AuthConnector';\nimport { RefreshingAuthSessionManager } from '../../../../lib/AuthSessionManager';\nimport { SessionManager } from '../../../../lib/AuthSessionManager/types';\nimport { Observable } from '../../../../types';\nimport {\n  AuthProvider,\n  OAuthRequestApi,\n  DiscoveryApi,\n} from '../../../definitions';\nimport {\n  AuthRequestOptions,\n  BackstageIdentity,\n  OAuthApi,\n  OpenIdConnectApi,\n  ProfileInfo,\n  ProfileInfoApi,\n  SessionState,\n  SessionApi,\n  BackstageIdentityApi,\n} from '../../../definitions/auth';\nimport { OAuth2Session } from './types';\n\ntype Options = {\n  sessionManager: SessionManager<OAuth2Session>;\n  scopeTransform: (scopes: string[]) => string[];\n};\n\ntype CreateOptions = {\n  discoveryApi: DiscoveryApi;\n  oauthRequestApi: OAuthRequestApi;\n\n  environment?: string;\n  provider?: AuthProvider & { id: string };\n  defaultScopes?: string[];\n  scopeTransform?: (scopes: string[]) => string[];\n};\n\nexport type OAuth2Response = {\n  providerInfo: {\n    accessToken: string;\n    idToken: string;\n    scope: string;\n    expiresInSeconds: number;\n  };\n  profile: ProfileInfo;\n  backstageIdentity: BackstageIdentity;\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'oauth2',\n  title: 'Your Identity Provider',\n  icon: OAuth2Icon,\n};\n\nclass OAuth2\n  implements\n    OAuthApi,\n    OpenIdConnectApi,\n    ProfileInfoApi,\n    BackstageIdentityApi,\n    SessionApi {\n  static create({\n    discoveryApi,\n    environment = 'development',\n    provider = DEFAULT_PROVIDER,\n    oauthRequestApi,\n    defaultScopes = [],\n    scopeTransform = x => x,\n  }: CreateOptions) {\n    const connector = new DefaultAuthConnector({\n      discoveryApi,\n      environment,\n      provider,\n      oauthRequestApi: oauthRequestApi,\n      sessionTransform(res: OAuth2Response): OAuth2Session {\n        return {\n          ...res,\n          providerInfo: {\n            idToken: res.providerInfo.idToken,\n            accessToken: res.providerInfo.accessToken,\n            scopes: OAuth2.normalizeScopes(\n              scopeTransform,\n              res.providerInfo.scope,\n            ),\n            expiresAt: new Date(\n              Date.now() + res.providerInfo.expiresInSeconds * 1000,\n            ),\n          },\n        };\n      },\n    });\n\n    const sessionManager = new RefreshingAuthSessionManager({\n      connector,\n      defaultScopes: new Set(defaultScopes),\n      sessionScopes: (session: OAuth2Session) => session.providerInfo.scopes,\n      sessionShouldRefresh: (session: OAuth2Session) => {\n        const expiresInSec =\n          (session.providerInfo.expiresAt.getTime() - Date.now()) / 1000;\n        return expiresInSec < 60 * 5;\n      },\n    });\n\n    return new OAuth2({ sessionManager, scopeTransform });\n  }\n\n  private readonly sessionManager: SessionManager<OAuth2Session>;\n  private readonly scopeTransform: (scopes: string[]) => string[];\n\n  constructor(options: Options) {\n    this.sessionManager = options.sessionManager;\n    this.scopeTransform = options.scopeTransform;\n  }\n\n  async signIn() {\n    await this.getAccessToken();\n  }\n\n  async signOut() {\n    await this.sessionManager.removeSession();\n  }\n\n  sessionState$(): Observable<SessionState> {\n    return this.sessionManager.sessionState$();\n  }\n\n  async getAccessToken(\n    scope?: string | string[],\n    options?: AuthRequestOptions,\n  ) {\n    const normalizedScopes = OAuth2.normalizeScopes(this.scopeTransform, scope);\n    const session = await this.sessionManager.getSession({\n      ...options,\n      scopes: normalizedScopes,\n    });\n    return session?.providerInfo.accessToken ?? '';\n  }\n\n  async getIdToken(options: AuthRequestOptions = {}) {\n    const session = await this.sessionManager.getSession(options);\n    return session?.providerInfo.idToken ?? '';\n  }\n\n  async getBackstageIdentity(\n    options: AuthRequestOptions = {},\n  ): Promise<BackstageIdentity | undefined> {\n    const session = await this.sessionManager.getSession(options);\n    return session?.backstageIdentity;\n  }\n\n  async getProfile(options: AuthRequestOptions = {}) {\n    const session = await this.sessionManager.getSession(options);\n    return session?.profile;\n  }\n\n  private static normalizeScopes(\n    scopeTransform: (scopes: string[]) => string[],\n    scopes?: string | string[],\n  ): Set<string> {\n    if (!scopes) {\n      return new Set();\n    }\n\n    const scopeList = Array.isArray(scopes)\n      ? scopes\n      : scopes.split(/[\\s|,]/).filter(Boolean);\n\n    return new Set(scopeTransform(scopeList));\n  }\n}\n\nexport default OAuth2;\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport GitlabIcon from '@material-ui/icons/AcUnit';\nimport { gitlabAuthApiRef } from '../../../definitions/auth';\nimport {\n  OAuthRequestApi,\n  AuthProvider,\n  DiscoveryApi,\n} from '../../../definitions';\nimport { OAuth2 } from '../oauth2';\n\ntype CreateOptions = {\n  discoveryApi: DiscoveryApi;\n  oauthRequestApi: OAuthRequestApi;\n\n  environment?: string;\n  provider?: AuthProvider & { id: string };\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'gitlab',\n  title: 'Gitlab',\n  icon: GitlabIcon,\n};\n\nclass GitlabAuth {\n  static create({\n    discoveryApi,\n    environment = 'development',\n    provider = DEFAULT_PROVIDER,\n    oauthRequestApi,\n  }: CreateOptions): typeof gitlabAuthApiRef.T {\n    return OAuth2.create({\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n      defaultScopes: ['read_user'],\n    });\n  }\n}\nexport default GitlabAuth;\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport GoogleIcon from '@material-ui/icons/AcUnit';\nimport { googleAuthApiRef } from '../../../definitions/auth';\nimport {\n  OAuthRequestApi,\n  AuthProvider,\n  DiscoveryApi,\n} from '../../../definitions';\nimport { OAuth2 } from '../oauth2';\n\ntype CreateOptions = {\n  discoveryApi: DiscoveryApi;\n  oauthRequestApi: OAuthRequestApi;\n\n  environment?: string;\n  provider?: AuthProvider & { id: string };\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'google',\n  title: 'Google',\n  icon: GoogleIcon,\n};\n\nclass GoogleAuth {\n  static create({\n    discoveryApi,\n    oauthRequestApi,\n    environment = 'development',\n    provider = DEFAULT_PROVIDER,\n  }: CreateOptions): typeof googleAuthApiRef.T {\n    const SCOPE_PREFIX = 'https://www.googleapis.com/auth/';\n\n    return OAuth2.create({\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n      defaultScopes: [\n        'openid',\n        `${SCOPE_PREFIX}userinfo.email`,\n        `${SCOPE_PREFIX}userinfo.profile`,\n      ],\n      scopeTransform(scopes: string[]) {\n        return scopes.map(scope => {\n          if (scope === 'openid') {\n            return scope;\n          }\n\n          if (scope === 'profile' || scope === 'email') {\n            return `${SCOPE_PREFIX}userinfo.${scope}`;\n          }\n\n          if (scope.startsWith(SCOPE_PREFIX)) {\n            return scope;\n          }\n\n          return `${SCOPE_PREFIX}${scope}`;\n        });\n      },\n    });\n  }\n}\nexport default GoogleAuth;\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport OktaIcon from '@material-ui/icons/AcUnit';\nimport { oktaAuthApiRef } from '../../../definitions/auth';\nimport {\n  OAuthRequestApi,\n  AuthProvider,\n  DiscoveryApi,\n} from '../../../definitions';\nimport { OAuth2 } from '../oauth2';\n\ntype CreateOptions = {\n  discoveryApi: DiscoveryApi;\n  oauthRequestApi: OAuthRequestApi;\n\n  environment?: string;\n  provider?: AuthProvider & { id: string };\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'okta',\n  title: 'Okta',\n  icon: OktaIcon,\n};\n\nconst OKTA_OIDC_SCOPES: Set<String> = new Set([\n  'openid',\n  'profile',\n  'email',\n  'phone',\n  'address',\n  'groups',\n  'offline_access',\n]);\n\nconst OKTA_SCOPE_PREFIX: string = 'okta.';\n\nclass OktaAuth {\n  static create({\n    discoveryApi,\n    environment = 'development',\n    provider = DEFAULT_PROVIDER,\n    oauthRequestApi,\n  }: CreateOptions): typeof oktaAuthApiRef.T {\n    return OAuth2.create({\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n      defaultScopes: ['openid', 'email', 'profile', 'offline_access'],\n      scopeTransform(scopes) {\n        return scopes.map(scope => {\n          if (OKTA_OIDC_SCOPES.has(scope)) {\n            return scope;\n          }\n\n          if (scope.startsWith(OKTA_SCOPE_PREFIX)) {\n            return scope;\n          }\n\n          return `${OKTA_SCOPE_PREFIX}${scope}`;\n        });\n      },\n    });\n  }\n}\n\nexport default OktaAuth;\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport SamlIcon from '@material-ui/icons/AcUnit';\nimport { DirectAuthConnector } from '../../../../lib/AuthConnector';\nimport { SessionManager } from '../../../../lib/AuthSessionManager/types';\nimport { Observable } from '../../../../types';\nimport {\n  ProfileInfo,\n  BackstageIdentity,\n  SessionState,\n  AuthRequestOptions,\n  ProfileInfoApi,\n  BackstageIdentityApi,\n  SessionApi,\n} from '../../../definitions/auth';\nimport { AuthProvider, DiscoveryApi } from '../../../definitions';\nimport { SamlSession } from './types';\nimport {\n  AuthSessionStore,\n  StaticAuthSessionManager,\n} from '../../../../lib/AuthSessionManager';\n\ntype CreateOptions = {\n  discoveryApi: DiscoveryApi;\n  environment?: string;\n  provider?: AuthProvider & { id: string };\n};\n\nexport type SamlAuthResponse = {\n  profile: ProfileInfo;\n  backstageIdentity: BackstageIdentity;\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'saml',\n  title: 'SAML',\n  icon: SamlIcon,\n};\n\nclass SamlAuth implements ProfileInfoApi, BackstageIdentityApi, SessionApi {\n  static create({\n    discoveryApi,\n    environment = 'development',\n    provider = DEFAULT_PROVIDER,\n  }: CreateOptions) {\n    const connector = new DirectAuthConnector<SamlSession>({\n      discoveryApi,\n      environment,\n      provider,\n    });\n\n    const sessionManager = new StaticAuthSessionManager<SamlSession>({\n      connector,\n    });\n\n    const authSessionStore = new AuthSessionStore<SamlSession>({\n      manager: sessionManager,\n      storageKey: 'samlSession',\n    });\n\n    return new SamlAuth(authSessionStore);\n  }\n\n  sessionState$(): Observable<SessionState> {\n    return this.sessionManager.sessionState$();\n  }\n\n  constructor(private readonly sessionManager: SessionManager<SamlSession>) {}\n\n  async signIn() {\n    await this.getBackstageIdentity({});\n  }\n  async signOut() {\n    await this.sessionManager.removeSession();\n  }\n\n  async getBackstageIdentity(\n    options: AuthRequestOptions,\n  ): Promise<BackstageIdentity | undefined> {\n    const session = await this.sessionManager.getSession(options);\n    return session?.backstageIdentity;\n  }\n\n  async getProfile(options: AuthRequestOptions = {}) {\n    const session = await this.sessionManager.getSession(options);\n    return session?.profile;\n  }\n}\n\nexport default SamlAuth;\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport Auth0Icon from '@material-ui/icons/AcUnit';\nimport { auth0AuthApiRef } from '../../../definitions/auth';\nimport {\n  OAuthRequestApi,\n  AuthProvider,\n  DiscoveryApi,\n} from '../../../definitions';\nimport { OAuth2 } from '../oauth2';\n\ntype CreateOptions = {\n  discoveryApi: DiscoveryApi;\n  oauthRequestApi: OAuthRequestApi;\n\n  environment?: string;\n  provider?: AuthProvider & { id: string };\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'auth0',\n  title: 'Auth0',\n  icon: Auth0Icon,\n};\n\nclass Auth0Auth {\n  static create({\n    discoveryApi,\n    environment = 'development',\n    provider = DEFAULT_PROVIDER,\n    oauthRequestApi,\n  }: CreateOptions): typeof auth0AuthApiRef.T {\n    return OAuth2.create({\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n      defaultScopes: ['openid', `email`, `profile`],\n    });\n  }\n}\n\nexport default Auth0Auth;\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport MicrosoftIcon from '@material-ui/icons/AcUnit';\nimport { microsoftAuthApiRef } from '../../../definitions/auth';\n\nimport {\n  OAuthRequestApi,\n  AuthProvider,\n  DiscoveryApi,\n} from '../../../definitions';\nimport { OAuth2 } from '../oauth2';\n\ntype CreateOptions = {\n  discoveryApi: DiscoveryApi;\n  oauthRequestApi: OAuthRequestApi;\n\n  environment?: string;\n  provider?: AuthProvider & { id: string };\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'microsoft',\n  title: 'Microsoft',\n  icon: MicrosoftIcon,\n};\n\nclass MicrosoftAuth {\n  static create({\n    environment = 'development',\n    provider = DEFAULT_PROVIDER,\n    oauthRequestApi,\n    discoveryApi,\n  }: CreateOptions): typeof microsoftAuthApiRef.T {\n    return OAuth2.create({\n      discoveryApi,\n      oauthRequestApi,\n      provider,\n      environment,\n      defaultScopes: [\n        'openid',\n        'offline_access',\n        'profile',\n        'email',\n        'User.Read',\n      ],\n    });\n  }\n}\n\nexport default MicrosoftAuth;\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { AlertApi, AlertMessage } from '../..';\nimport { PublishSubject } from '../../../lib';\nimport { Observable } from '../../../types';\n\n/**\n * Base implementation for the AlertApi that simply forwards alerts to consumers.\n */\nexport class AlertApiForwarder implements AlertApi {\n  private readonly subject = new PublishSubject<AlertMessage>();\n\n  post(alert: AlertMessage) {\n    this.subject.next(alert);\n  }\n\n  alert$(): Observable<AlertMessage> {\n    return this.subject;\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AppThemeApi, AppTheme } from '../../definitions';\nimport { BehaviorSubject } from '../../../lib';\nimport { Observable } from '../../../types';\n\nconst STORAGE_KEY = 'theme';\n\nexport class AppThemeSelector implements AppThemeApi {\n  static createWithStorage(themes: AppTheme[]) {\n    const selector = new AppThemeSelector(themes);\n\n    if (!window.localStorage) {\n      return selector;\n    }\n\n    const initialThemeId =\n      window.localStorage.getItem(STORAGE_KEY) ?? undefined;\n\n    selector.setActiveThemeId(initialThemeId);\n\n    selector.activeThemeId$().subscribe(themeId => {\n      if (themeId) {\n        window.localStorage.setItem(STORAGE_KEY, themeId);\n      } else {\n        window.localStorage.removeItem(STORAGE_KEY);\n      }\n    });\n\n    window.addEventListener('storage', event => {\n      if (event.key === STORAGE_KEY) {\n        const themeId = localStorage.getItem(STORAGE_KEY) ?? undefined;\n        selector.setActiveThemeId(themeId);\n      }\n    });\n\n    return selector;\n  }\n\n  private activeThemeId: string | undefined;\n  private readonly subject = new BehaviorSubject<string | undefined>(undefined);\n\n  constructor(private readonly themes: AppTheme[]) {}\n\n  getInstalledThemes(): AppTheme[] {\n    return this.themes.slice();\n  }\n\n  activeThemeId$(): Observable<string | undefined> {\n    return this.subject;\n  }\n\n  getActiveThemeId(): string | undefined {\n    return this.activeThemeId;\n  }\n\n  setActiveThemeId(themeId?: string): void {\n    this.activeThemeId = themeId;\n    this.subject.next(themeId);\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { ErrorApi, ErrorContext, AlertApi } from '../..';\n\n/**\n * Decorates an ErrorApi by also forwarding error messages\n * to the alertApi with an 'error' severity.\n */\nexport class ErrorAlerter implements ErrorApi {\n  constructor(\n    private readonly alertApi: AlertApi,\n    private readonly errorApi: ErrorApi,\n  ) {}\n\n  post(error: Error, context?: ErrorContext) {\n    if (!context?.hidden) {\n      this.alertApi.post({ message: error.message, severity: 'error' });\n    }\n\n    return this.errorApi.post(error, context);\n  }\n\n  error$() {\n    return this.errorApi.error$();\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { ErrorApi, ErrorContext } from '../..';\nimport { PublishSubject } from '../../../lib';\nimport { Observable } from '../../../types';\n\n/**\n * Base implementation for the ErrorApi that simply forwards errors to consumers.\n */\nexport class ErrorApiForwarder implements ErrorApi {\n  private readonly subject = new PublishSubject<{\n    error: Error;\n    context?: ErrorContext;\n  }>();\n\n  post(error: Error, context?: ErrorContext) {\n    this.subject.next({ error, context });\n  }\n\n  error$(): Observable<{ error: Error; context?: ErrorContext }> {\n    return this.subject;\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { DiscoveryApi } from '../../definitions/DiscoveryApi';\n\n/**\n * UrlPatternDiscovery is a lightweight DiscoveryApi implementation.\n * It uses a single template string to construct URLs for each plugin.\n */\nexport class UrlPatternDiscovery implements DiscoveryApi {\n  /**\n   * Creates a new UrlPatternDiscovery given a template. The the only\n   * interpolation done for the template is to replace instances of `{{pluginId}}`\n   * with the ID of the plugin being requested.\n   *\n   * Example pattern: `http://localhost:7000/api/{{ pluginId }}`\n   */\n  static compile(pattern: string): UrlPatternDiscovery {\n    const parts = pattern.split(/\\{\\{\\s*pluginId\\s*\\}\\}/);\n\n    try {\n      const urlStr = parts.join('pluginId');\n      const url = new URL(urlStr);\n      if (url.hash) {\n        throw new Error('URL must not have a hash');\n      }\n      if (url.search) {\n        throw new Error('URL must not have a query');\n      }\n      if (urlStr.endsWith('/')) {\n        throw new Error('URL must not end with a slash');\n      }\n    } catch (error) {\n      throw new Error(`Invalid discovery URL pattern, ${error.message}`);\n    }\n\n    return new UrlPatternDiscovery(parts);\n  }\n\n  private constructor(private readonly parts: string[]) {}\n\n  async getBaseUrl(pluginId: string): Promise<string> {\n    return this.parts.join(pluginId);\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { BehaviorSubject } from '../../../lib';\nimport { Observable } from '../../../types';\n\ntype RequestQueueEntry<ResultType> = {\n  scopes: Set<string>;\n  resolve: (value?: ResultType | PromiseLike<ResultType> | undefined) => void;\n  reject: (reason: Error) => void;\n};\n\nexport type PendingRequest<ResultType> = {\n  scopes: Set<string> | undefined;\n  resolve: (value: ResultType) => void;\n  reject: (reason: Error) => void;\n};\n\nexport function hasScopes(\n  searched: Set<string>,\n  searchFor: Set<string>,\n): boolean {\n  for (const scope of searchFor) {\n    if (!searched.has(scope)) {\n      return false;\n    }\n  }\n  return true;\n}\n\nexport function joinScopes(\n  scopes: Set<string>,\n  ...moreScopess: Set<string>[]\n): Set<string> {\n  const result = new Set(scopes);\n\n  for (const moreScopes of moreScopess) {\n    for (const scope of moreScopes) {\n      result.add(scope);\n    }\n  }\n\n  return result;\n}\n\n/**\n * The OAuthPendingRequests class is a utility for managing and observing\n * a stream of requests for oauth scopes for a single provider, and resolving\n * them correctly once requests are fulfilled.\n */\nexport class OAuthPendingRequests<ResultType> {\n  private requests: RequestQueueEntry<ResultType>[] = [];\n  private subject = new BehaviorSubject<PendingRequest<ResultType>>(\n    this.getCurrentPending(),\n  );\n\n  request(scopes: Set<string>): Promise<ResultType> {\n    return new Promise((resolve, reject) => {\n      this.requests.push({ scopes, resolve, reject });\n\n      this.subject.next(this.getCurrentPending());\n    });\n  }\n\n  resolve(scopes: Set<string>, result: ResultType): void {\n    this.requests = this.requests.filter(request => {\n      if (hasScopes(scopes, request.scopes)) {\n        request.resolve(result);\n        return false;\n      }\n      return true;\n    });\n\n    this.subject.next(this.getCurrentPending());\n  }\n\n  reject(error: Error) {\n    this.requests.forEach(request => request.reject(error));\n    this.requests = [];\n\n    this.subject.next(this.getCurrentPending());\n  }\n\n  pending(): Observable<PendingRequest<ResultType>> {\n    return this.subject;\n  }\n\n  private getCurrentPending(): PendingRequest<ResultType> {\n    const currentScopes =\n      this.requests.length === 0\n        ? undefined\n        : this.requests\n            .slice(1)\n            .reduce(\n              (acc, current) => joinScopes(acc, current.scopes),\n              this.requests[0].scopes,\n            );\n\n    return {\n      scopes: currentScopes,\n      resolve: (value: ResultType) => {\n        if (currentScopes) {\n          this.resolve(currentScopes, value);\n        }\n      },\n      reject: (reason: Error) => {\n        if (currentScopes) {\n          this.reject(reason);\n        }\n      },\n    };\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  OAuthRequestApi,\n  PendingAuthRequest,\n  AuthRequester,\n  AuthRequesterOptions,\n} from '../../definitions';\nimport { OAuthPendingRequests, PendingRequest } from './OAuthPendingRequests';\nimport { BehaviorSubject } from '../../../lib';\nimport { Observable } from '../../../types';\n\n/**\n * The OAuthRequestManager is an implementation of the OAuthRequestApi.\n *\n * The purpose of this class and the API is to read a stream of incoming requests\n * of OAuth access tokens from different providers with varying scope, and funnel\n * them all together into a single request for each OAuth provider.\n */\nexport class OAuthRequestManager implements OAuthRequestApi {\n  private readonly subject = new BehaviorSubject<PendingAuthRequest[]>([]);\n  private currentRequests: PendingAuthRequest[] = [];\n  private handlerCount = 0;\n\n  createAuthRequester<T>(options: AuthRequesterOptions<T>): AuthRequester<T> {\n    const handler = new OAuthPendingRequests<T>();\n\n    const index = this.handlerCount;\n    this.handlerCount++;\n\n    handler.pending().subscribe({\n      next: scopeRequest => {\n        const newRequests = this.currentRequests.slice();\n        const request = this.makeAuthRequest(scopeRequest, options);\n        if (!request) {\n          delete newRequests[index];\n        } else {\n          newRequests[index] = request;\n        }\n        this.currentRequests = newRequests;\n        // Convert from sparse array to array of present items only\n        this.subject.next(newRequests.filter(Boolean));\n      },\n    });\n\n    return scopes => {\n      return handler.request(scopes);\n    };\n  }\n\n  // Converts the pending request and popup options into a popup request that we can forward to subscribers.\n  private makeAuthRequest(\n    request: PendingRequest<any>,\n    options: AuthRequesterOptions<any>,\n  ): PendingAuthRequest | undefined {\n    const { scopes } = request;\n    if (!scopes) {\n      return undefined;\n    }\n\n    return {\n      provider: options.provider,\n      trigger: async () => {\n        const result = await options.onAuthRequest(scopes);\n        request.resolve(result);\n      },\n      reject: () => {\n        const error = new Error('Login failed, rejected by user');\n        error.name = 'RejectedError';\n        request.reject(error);\n      },\n    };\n  }\n\n  authRequest$(): Observable<PendingAuthRequest[]> {\n    return this.subject;\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  StorageApi,\n  StorageValueChange,\n  ErrorApi,\n  CreateStorageApiOptions,\n} from '../../definitions';\nimport { Observable } from '../../../types';\nimport ObservableImpl from 'zen-observable';\n\nconst buckets = new Map<string, WebStorage>();\n\nexport class WebStorage implements StorageApi {\n  constructor(\n    private readonly namespace: string,\n    private readonly errorApi: ErrorApi,\n  ) {}\n\n  static create(options: CreateStorageApiOptions): WebStorage {\n    return new WebStorage(options.namespace ?? '', options.errorApi);\n  }\n\n  get<T>(key: string): T | undefined {\n    try {\n      const storage = JSON.parse(localStorage.getItem(this.getKeyName(key))!);\n      return storage ?? undefined;\n    } catch (e) {\n      this.errorApi.post(\n        new Error(`Error when parsing JSON config from storage for: ${key}`),\n      );\n    }\n\n    return undefined;\n  }\n\n  forBucket(name: string): WebStorage {\n    const bucketPath = `${this.namespace}/${name}`;\n    if (!buckets.has(bucketPath)) {\n      buckets.set(bucketPath, new WebStorage(bucketPath, this.errorApi));\n    }\n    return buckets.get(bucketPath)!;\n  }\n\n  async set<T>(key: string, data: T): Promise<void> {\n    localStorage.setItem(this.getKeyName(key), JSON.stringify(data, null, 2));\n    this.notifyChanges({ key, newValue: data });\n  }\n\n  async remove(key: string): Promise<void> {\n    localStorage.removeItem(this.getKeyName(key));\n    this.notifyChanges({ key, newValue: undefined });\n  }\n\n  observe$<T>(key: string): Observable<StorageValueChange<T>> {\n    return this.observable.filter(({ key: messageKey }) => messageKey === key);\n  }\n\n  private getKeyName(key: string) {\n    return `${this.namespace}/${encodeURIComponent(key)}`;\n  }\n\n  private notifyChanges<T>(message: StorageValueChange<T>) {\n    for (const subscription of this.subscribers) {\n      subscription.next(message);\n    }\n  }\n\n  private subscribers = new Set<\n    ZenObservable.SubscriptionObserver<StorageValueChange>\n  >();\n\n  private readonly observable = new ObservableImpl<StorageValueChange>(\n    subscriber => {\n      this.subscribers.add(subscriber);\n      return () => {\n        this.subscribers.delete(subscriber);\n      };\n    },\n  );\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { FeatureFlagName } from '../plugin/types';\nimport {\n  FeatureFlagState,\n  FeatureFlagsApi,\n  FeatureFlagsRegistryItem,\n} from '../apis/definitions';\n\n/**\n * Helper method for validating compatibility and flag name.\n */\nexport function validateBrowserCompat(): void {\n  if (!('localStorage' in window)) {\n    throw new Error(\n      'Feature Flags are not supported on browsers without the Local Storage API',\n    );\n  }\n}\n\nexport function validateFlagName(name: FeatureFlagName): void {\n  if (name.length < 3) {\n    throw new Error(\n      `The '${name}' feature flag must have a minimum length of three characters.`,\n    );\n  }\n\n  if (name.length > 150) {\n    throw new Error(\n      `The '${name}' feature flag must not exceed 150 characters.`,\n    );\n  }\n\n  if (!name.match(/^[a-z]+[a-z0-9-]+$/)) {\n    throw new Error(\n      `The '${name}' feature flag must start with a lowercase letter and only contain lowercase letters, numbers and hyphens. ` +\n        'Examples: feature-flag-one, alpha, release-2020',\n    );\n  }\n}\n\n/**\n * The UserFlags class.\n *\n * This acts as a data structure for the user's feature flags. You\n * can use this to retrieve, add, edit, delete, clear and save the user's\n * feature flags to the local browser for persisted storage.\n */\nexport class UserFlags extends Map<FeatureFlagName, FeatureFlagState> {\n  static load(): UserFlags {\n    validateBrowserCompat();\n\n    try {\n      const jsonString = window.localStorage.getItem('featureFlags') as string;\n      const json = JSON.parse(jsonString);\n      return new this(Object.entries(json));\n    } catch (err) {\n      return new this([]);\n    }\n  }\n\n  get(name: FeatureFlagName): FeatureFlagState {\n    return super.get(name) || FeatureFlagState.Off;\n  }\n\n  set(name: FeatureFlagName, state: FeatureFlagState): this {\n    validateFlagName(name);\n    const output = super.set(name, state);\n    this.save();\n    return output;\n  }\n\n  toggle(name: FeatureFlagName): FeatureFlagState {\n    if (super.get(name) === FeatureFlagState.On) {\n      super.set(name, FeatureFlagState.Off);\n    } else {\n      super.set(name, FeatureFlagState.On);\n    }\n    return super.get(name) || FeatureFlagState.Off;\n  }\n\n  delete(name: FeatureFlagName): boolean {\n    const output = super.delete(name);\n    this.save();\n    return output;\n  }\n\n  clear(): void {\n    super.clear();\n    this.save();\n  }\n\n  save(): void {\n    window.localStorage.setItem(\n      'featureFlags',\n      JSON.stringify(this.toObject()),\n    );\n  }\n\n  toObject() {\n    return Array.from(this.entries()).reduce(\n      (obj, [key, value]) => ({ ...obj, [key]: value }),\n      {},\n    );\n  }\n\n  toJSON() {\n    return JSON.stringify(this.toObject());\n  }\n\n  toString() {\n    return this.toJSON();\n  }\n}\n\n/**\n * The FeatureFlagsRegistry class.\n *\n * This acts as a holding data structure for feature flags\n * that plugins wish to register for use in Backstage.\n */\n\nexport class FeatureFlagsRegistry extends Array<FeatureFlagsRegistryItem> {\n  static from(entries: FeatureFlagsRegistryItem[]) {\n    Array.from(entries).forEach(entry => validateFlagName(entry.name));\n    return new FeatureFlagsRegistry(...entries);\n  }\n\n  push(...entries: FeatureFlagsRegistryItem[]): number {\n    Array.from(entries).forEach(entry => validateFlagName(entry.name));\n    return super.push(...entries);\n  }\n\n  concat(\n    ...entries: (\n      | FeatureFlagsRegistryItem\n      | ConcatArray<FeatureFlagsRegistryItem>\n    )[]\n  ): FeatureFlagsRegistryItem[] {\n    const _concat = super.concat(...entries);\n    Array.from(_concat).forEach(entry => validateFlagName(entry.name));\n    return _concat;\n  }\n\n  toObject() {\n    return [...this.values()];\n  }\n\n  toJSON() {\n    return JSON.stringify(this.toObject());\n  }\n\n  toString() {\n    return this.toJSON();\n  }\n}\n\n/**\n * Create the FeatureFlags implementation based on the API.\n */\nexport class FeatureFlags implements FeatureFlagsApi {\n  public registeredFeatureFlags: FeatureFlagsRegistryItem[] = [];\n  private userFlags: UserFlags | undefined;\n\n  getFlags(): UserFlags {\n    if (!this.userFlags) this.userFlags = UserFlags.load();\n    return this.userFlags;\n  }\n\n  getRegisteredFlags(): FeatureFlagsRegistry {\n    return FeatureFlagsRegistry.from(this.registeredFeatureFlags);\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { createContext, useContext, FC } from 'react';\nimport { BackstageApp } from './types';\n\nconst Context = createContext<BackstageApp | undefined>(undefined);\n\ntype Props = {\n  app: BackstageApp;\n};\n\nexport const AppContextProvider: FC<Props> = ({ app, children }) => (\n  <Context.Provider value={app} children={children} />\n);\n\nexport const useApp = (): BackstageApp => {\n  const app = useContext(Context);\n  if (!app) {\n    throw new Error('No app context available');\n  }\n  return app;\n};\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { SvgIconProps } from '@material-ui/core';\nimport PeopleIcon from '@material-ui/icons/People';\nimport PersonIcon from '@material-ui/icons/Person';\nimport React, { FC } from 'react';\nimport { useApp } from '../app/AppContext';\nimport { IconComponent, SystemIconKey, SystemIcons } from './types';\n\nexport const defaultSystemIcons: SystemIcons = {\n  user: PersonIcon,\n  group: PeopleIcon,\n};\n\nconst overridableSystemIcon = (key: SystemIconKey): IconComponent => {\n  const Component: FC<SvgIconProps> = props => {\n    const app = useApp();\n    const Icon = app.getSystemIcon(key);\n    return <Icon {...props} />;\n  };\n  return Component;\n};\n\nexport const UserIcon = overridableSystemIcon('user');\nexport const GroupIcon = overridableSystemIcon('group');\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ComponentType } from 'react';\nimport {\n  PluginOutput,\n  RoutePath,\n  RouteOptions,\n  FeatureFlagName,\n  BackstagePlugin,\n} from './types';\nimport { validateBrowserCompat, validateFlagName } from '../app/FeatureFlags';\nimport { RouteRef } from '../routing';\nimport { AnyApiFactory } from '../apis';\n\nexport type PluginConfig = {\n  id: string;\n  apis?: Iterable<AnyApiFactory>;\n  register?(hooks: PluginHooks): void;\n};\n\nexport type PluginHooks = {\n  router: RouterHooks;\n  featureFlags: FeatureFlagsHooks;\n};\n\nexport type RouterHooks = {\n  addRoute(\n    target: RouteRef,\n    Component: ComponentType<any>,\n    options?: RouteOptions,\n  ): void;\n\n  /**\n   * @deprecated See the `addRoute` method\n   */\n  registerRoute(\n    path: RoutePath,\n    Component: ComponentType<any>,\n    options?: RouteOptions,\n  ): void;\n};\n\nexport type FeatureFlagsHooks = {\n  register(name: FeatureFlagName): void;\n};\n\nexport class PluginImpl {\n  private storedOutput?: PluginOutput[];\n\n  constructor(private readonly config: PluginConfig) {}\n\n  getId(): string {\n    return this.config.id;\n  }\n\n  getApis(): Iterable<AnyApiFactory> {\n    return this.config.apis ?? [];\n  }\n\n  output(): PluginOutput[] {\n    if (this.storedOutput) {\n      return this.storedOutput;\n    }\n    if (!this.config.register) {\n      return [];\n    }\n\n    const outputs = new Array<PluginOutput>();\n\n    this.config.register({\n      router: {\n        addRoute(target, component, options) {\n          outputs.push({\n            type: 'route',\n            target,\n            component,\n            options,\n          });\n        },\n        registerRoute(path, component, options) {\n          outputs.push({ type: 'legacy-route', path, component, options });\n        },\n      },\n      featureFlags: {\n        register(name) {\n          validateBrowserCompat();\n          validateFlagName(name);\n          outputs.push({ type: 'feature-flag', name });\n        },\n      },\n    });\n\n    this.storedOutput = outputs;\n    return this.storedOutput;\n  }\n\n  toString() {\n    return `plugin{${this.config.id}}`;\n  }\n}\n\nexport function createPlugin(config: PluginConfig): BackstagePlugin {\n  return new PluginImpl(config);\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { IconComponent } from '../icons';\n\nexport const resolveRoute = Symbol('resolve-route');\nexport const routeReference = Symbol('route-ref');\n\nexport type ReferencedRoute = {\n  [routeReference]: unknown;\n};\n\nexport type ConcreteRoute = ReferencedRoute & {\n  [resolveRoute](path: string): string;\n};\n\nexport type RouteRef = {\n  // TODO(Rugvip): Remove path, look up via registry instead\n  path: string;\n  icon?: IconComponent;\n  title: string;\n};\n\nexport type RouteRefConfig = {\n  path: string;\n  icon?: IconComponent;\n  title: string;\n};\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ConcreteRoute,\n  routeReference,\n  ReferencedRoute,\n  resolveRoute,\n  RouteRefConfig,\n} from './types';\nimport { generatePath } from 'react-router-dom';\n\ntype SubRouteConfig = {\n  path: string;\n};\n\nexport class SubRouteRef<T extends { [name in string]: string } | never = never>\n  implements ReferencedRoute {\n  constructor(\n    private readonly parent: ConcreteRoute,\n    private readonly config: SubRouteConfig,\n  ) {}\n\n  get [routeReference]() {\n    return this;\n  }\n\n  link<Args extends T extends never ? [] : [T]>(...args: Args): ConcreteRoute {\n    return {\n      [routeReference]: this,\n      [resolveRoute]: (path: string) => {\n        const ownPart = generatePath(this.config.path, args[0] ?? {});\n        const parentPart = this.parent[resolveRoute](path);\n        return parentPart + ownPart;\n      },\n    };\n  }\n}\n\nexport class AbsoluteRouteRef implements ConcreteRoute {\n  constructor(private readonly config: RouteRefConfig) {}\n\n  get icon() {\n    return this.config.icon;\n  }\n\n  // TODO(Rugvip): Remove this, routes are looked up via the registry instead\n  get path() {\n    return this.config.path;\n  }\n\n  get title() {\n    return this.config.title;\n  }\n\n  createSubRoute<T extends { [name in string]: string } | never = never>(\n    config: SubRouteConfig,\n  ) {\n    return new SubRouteRef<T>(this, config);\n  }\n\n  get [routeReference]() {\n    return this;\n  }\n\n  [resolveRoute](path: string) {\n    return path;\n  }\n}\n\nexport function createRouteRef(config: RouteRefConfig): AbsoluteRouteRef {\n  return new AbsoluteRouteRef(config);\n}\n\n// TODO(Rugvip): Added for backwards compatibility, remove once old usage is gone\n// We may want to avoid exporting the AbsoluteRouteRef itself though, and consider\n// a different model for how to create sub routes, just avoid this\nexport type MutableRouteRef = AbsoluteRouteRef;\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { FC, useMemo, useEffect, useState } from 'react';\nimport { ThemeProvider, CssBaseline } from '@material-ui/core';\nimport { useApi, appThemeApiRef, AppTheme } from '../apis';\nimport { useObservable } from 'react-use';\n\n// This tries to find the most accurate match, but also falls back to less\n// accurate results in order to avoid errors.\nfunction resolveTheme(\n  themeId: string | undefined,\n  shouldPreferDark: boolean,\n  themes: AppTheme[],\n) {\n  if (themeId !== undefined) {\n    const selectedTheme = themes.find(theme => theme.id === themeId);\n    if (selectedTheme) {\n      return selectedTheme;\n    }\n  }\n\n  if (shouldPreferDark) {\n    const darkTheme = themes.find(theme => theme.variant === 'dark');\n    if (darkTheme) {\n      return darkTheme;\n    }\n  }\n\n  const lightTheme = themes.find(theme => theme.variant === 'light');\n  if (lightTheme) {\n    return lightTheme;\n  }\n\n  return themes[0];\n}\n\nconst useShouldPreferDarkTheme = () => {\n  const mediaQuery = useMemo(\n    () => window.matchMedia('(prefers-color-scheme: dark)'),\n    [],\n  );\n  const [shouldPreferDark, setPrefersDark] = useState(mediaQuery.matches);\n\n  useEffect(() => {\n    const listener = (event: MediaQueryListEvent) => {\n      setPrefersDark(event.matches);\n    };\n    mediaQuery.addListener(listener);\n    return () => {\n      mediaQuery.removeListener(listener);\n    };\n  }, [mediaQuery]);\n\n  return shouldPreferDark;\n};\n\nexport const AppThemeProvider: FC<{}> = ({ children }) => {\n  const appThemeApi = useApi(appThemeApiRef);\n  const themeId = useObservable(\n    appThemeApi.activeThemeId$(),\n    appThemeApi.getActiveThemeId(),\n  );\n\n  // Browser feature detection won't change over time, so ignore lint rule\n  const shouldPreferDark = Boolean(window.matchMedia)\n    ? useShouldPreferDarkTheme() // eslint-disable-line react-hooks/rules-of-hooks\n    : false;\n\n  const appTheme = resolveTheme(\n    themeId,\n    shouldPreferDark,\n    appThemeApi.getInstalledThemes(),\n  );\n  if (!appTheme) {\n    throw new Error('App has no themes');\n  }\n\n  return (\n    <ThemeProvider theme={appTheme.theme}>\n      <CssBaseline>{children}</CssBaseline>\n    </ThemeProvider>\n  );\n};\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { IdentityApi, ProfileInfo } from '../apis';\nimport { SignInResult } from './types';\n\n/**\n * Implementation of the connection between the App-wide IdentityApi\n * and sign-in page.\n */\nexport class AppIdentity implements IdentityApi {\n  private hasIdentity = false;\n  private userId?: string;\n  private profile?: ProfileInfo;\n  private idTokenFunc?: () => Promise<string>;\n  private signOutFunc?: () => Promise<void>;\n\n  getUserId(): string {\n    if (!this.hasIdentity) {\n      throw new Error(\n        'Tried to access IdentityApi userId before app was loaded',\n      );\n    }\n    return this.userId!;\n  }\n\n  getProfile(): ProfileInfo {\n    if (!this.hasIdentity) {\n      throw new Error(\n        'Tried to access IdentityApi profile before app was loaded',\n      );\n    }\n    return this.profile!;\n  }\n\n  async getIdToken(): Promise<string | undefined> {\n    if (!this.hasIdentity) {\n      throw new Error(\n        'Tried to access IdentityApi idToken before app was loaded',\n      );\n    }\n    return this.idTokenFunc?.();\n  }\n\n  async signOut(): Promise<void> {\n    if (!this.hasIdentity) {\n      throw new Error(\n        'Tried to access IdentityApi signOutFunc before app was loaded',\n      );\n    }\n    await this.signOutFunc?.();\n    location.reload();\n  }\n\n  // This is indirectly called by the sign-in page to continue into the app.\n  setSignInResult(result: SignInResult) {\n    if (this.hasIdentity) {\n      return;\n    }\n    if (!result.userId) {\n      throw new Error('Invalid sign-in result, userId not set');\n    }\n    if (!result.profile) {\n      throw new Error('Invalid sign-in result, profile not set');\n    }\n    this.hasIdentity = true;\n    this.userId = result.userId;\n    this.profile = result.profile;\n    this.idTokenFunc = result.getIdToken;\n    this.signOutFunc = result.signOut;\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ApiFactoryHolder,\n  ApiFactory,\n  AnyApiRef,\n  AnyApiFactory,\n} from './types';\nimport { ApiRef } from './ApiRef';\n\ntype ApiFactoryScope =\n  | 'default' // Default factories registered by core and plugins\n  | 'app' // Factories registered in the app, overriding default ones\n  | 'static'; // APIs that can't be overridden, e.g. config\n\nenum ScopePriority {\n  default = 10,\n  app = 50,\n  static = 100,\n}\n\ntype FactoryTuple = {\n  priority: number;\n  factory: AnyApiFactory;\n};\n\n/**\n * ApiFactoryRegistry is an ApiFactoryHolder implementation that enables\n * registration of API Factories with different scope.\n *\n * Each scope has an assigned priority, where factories registered with\n * higher priority scopes override ones with lower priority.\n */\nexport class ApiFactoryRegistry implements ApiFactoryHolder {\n  private readonly factories = new Map<AnyApiRef, FactoryTuple>();\n\n  /**\n   * Register a new API factory. Returns true if the factory was added\n   * to the registry.\n   *\n   * A factory will not be added to the registry if there is already\n   * an existing factory with the same or higher priority.\n   */\n  register<Api, Deps extends { [name in string]: unknown }>(\n    scope: ApiFactoryScope,\n    factory: ApiFactory<Api, Deps>,\n  ) {\n    const priority = ScopePriority[scope];\n    const existing = this.factories.get(factory.api);\n    if (existing && existing.priority >= priority) {\n      return false;\n    }\n\n    this.factories.set(factory.api, { priority, factory });\n    return true;\n  }\n\n  get<T>(api: ApiRef<T>): ApiFactory<T, { [x: string]: unknown }> | undefined {\n    const tuple = this.factories.get(api);\n    if (!tuple) {\n      return undefined;\n    }\n    return tuple.factory as ApiFactory<T, { [x: string]: unknown }>;\n  }\n\n  getAllApis(): Set<AnyApiRef> {\n    return new Set(this.factories.keys());\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ApiRef } from './ApiRef';\nimport {\n  ApiHolder,\n  ApiFactoryHolder,\n  AnyApiRef,\n  TypesToApiRefs,\n} from './types';\n\nexport class ApiResolver implements ApiHolder {\n  private readonly apis = new Map<AnyApiRef, unknown>();\n\n  /**\n   * Validate factories by making sure that each of the apis can be created\n   * without hitting any circular dependencies.\n   */\n  static validateFactories(\n    factories: ApiFactoryHolder,\n    apis: Iterable<AnyApiRef>,\n  ) {\n    for (const api of apis) {\n      const heap = [api];\n      const allDeps = new Set<AnyApiRef>();\n\n      while (heap.length) {\n        const apiRef = heap.shift()!;\n        const factory = factories.get(apiRef);\n        if (!factory) {\n          continue;\n        }\n\n        for (const dep of Object.values(factory.deps)) {\n          if (dep === api) {\n            throw new Error(`Circular dependency of api factory for ${api}`);\n          }\n          if (!allDeps.has(dep)) {\n            allDeps.add(dep);\n            heap.push(dep);\n          }\n        }\n      }\n    }\n  }\n\n  constructor(private readonly factories: ApiFactoryHolder) {}\n\n  get<T>(ref: ApiRef<T>): T | undefined {\n    return this.load(ref);\n  }\n\n  private load<T>(ref: ApiRef<T>, loading: AnyApiRef[] = []): T | undefined {\n    const impl = this.apis.get(ref);\n    if (impl) {\n      return impl as T;\n    }\n\n    const factory = this.factories.get(ref);\n    if (!factory) {\n      return undefined;\n    }\n\n    if (loading.includes(factory.api)) {\n      throw new Error(`Circular dependency of api factory for ${factory.api}`);\n    }\n\n    const deps = this.loadDeps(ref, factory.deps, [...loading, factory.api]);\n    const api = factory.factory(deps);\n    this.apis.set(ref, api);\n    return api as T;\n  }\n\n  private loadDeps<T>(\n    dependent: ApiRef<unknown>,\n    apis: TypesToApiRefs<T>,\n    loading: AnyApiRef[],\n  ): T {\n    const impls = {} as T;\n\n    for (const key in apis) {\n      if (apis.hasOwnProperty(key)) {\n        const ref = apis[key];\n\n        const api = this.load(ref, loading);\n        if (!api) {\n          throw new Error(\n            `No API factory available for dependency ${ref} of dependent ${dependent}`,\n          );\n        }\n        impls[key] = api;\n      }\n    }\n\n    return impls;\n  }\n}\n","/*\n * Copyright 2020 Spotify AB\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport React, {\n  ComponentType,\n  FC,\n  useMemo,\n  useState,\n  ReactElement,\n} from 'react';\nimport { Route, Routes, Navigate } from 'react-router-dom';\nimport { AppContextProvider } from './AppContext';\nimport {\n  BackstageApp,\n  AppComponents,\n  AppConfigLoader,\n  SignInResult,\n  SignInPageProps,\n} from './types';\nimport { BackstagePlugin } from '../plugin';\nimport {\n  featureFlagsApiRef,\n  AppThemeApi,\n  ConfigApi,\n  identityApiRef,\n  FeatureFlagsRegistryItem,\n} from '../apis/definitions';\nimport { AppThemeProvider } from './AppThemeProvider';\n\nimport { IconComponent, SystemIcons, SystemIconKey } from '../icons';\nimport {\n  ApiProvider,\n  ApiRegistry,\n  AppTheme,\n  AppThemeSelector,\n  appThemeApiRef,\n  configApiRef,\n  ConfigReader,\n  useApi,\n  AnyApiFactory,\n  ApiHolder,\n} from '../apis';\nimport { useAsync } from 'react-use';\nimport { AppIdentity } from './AppIdentity';\nimport { ApiFactoryRegistry } from '../apis/ApiFactoryRegistry';\nimport { ApiResolver } from '../apis/ApiResolver';\n\ntype FullAppOptions = {\n  apis: Iterable<AnyApiFactory>;\n  icons: SystemIcons;\n  plugins: BackstagePlugin[];\n  components: AppComponents;\n  themes: AppTheme[];\n  configLoader?: AppConfigLoader;\n  defaultApis: Iterable<AnyApiFactory>;\n};\n\nfunction useConfigLoader(\n  configLoader: AppConfigLoader | undefined,\n  components: AppComponents,\n  appThemeApi: AppThemeApi,\n): { api: ConfigApi } | { node: JSX.Element } {\n  // Keeping this synchronous when a config loader isn't set simplifies tests a lot\n  const hasConfig = Boolean(configLoader);\n  const config = useAsync(configLoader || (() => Promise.resolve([])));\n\n  let noConfigNode = undefined;\n\n  if (hasConfig && config.loading) {\n    const { Progress } = components;\n    noConfigNode = <Progress />;\n  } else if (config.error) {\n    const { BootErrorPage } = components;\n    noConfigNode = <BootErrorPage step=\"load-config\" error={config.error} />;\n  }\n\n  // Before the config is loaded we can't use a router, so exit early\n  if (noConfigNode) {\n    return {\n      node: (\n        <ApiProvider apis={ApiRegistry.from([[appThemeApiRef, appThemeApi]])}>\n          <AppThemeProvider>{noConfigNode}</AppThemeProvider>\n        </ApiProvider>\n      ),\n    };\n  }\n\n  const configReader = ConfigReader.fromConfigs(config.value ?? []);\n\n  return { api: configReader };\n}\n\nexport class PrivateAppImpl implements BackstageApp {\n  private apiHolder?: ApiHolder;\n  private configApi?: ConfigApi;\n\n  private readonly apis: Iterable<AnyApiFactory>;\n  private readonly icons: SystemIcons;\n  private readonly plugins: BackstagePlugin[];\n  private readonly components: AppComponents;\n  private readonly themes: AppTheme[];\n  private readonly configLoader?: AppConfigLoader;\n  private readonly defaultApis: Iterable<AnyApiFactory>;\n\n  private readonly identityApi = new AppIdentity();\n\n  constructor(options: FullAppOptions) {\n    this.apis = options.apis;\n    this.icons = options.icons;\n    this.plugins = options.plugins;\n    this.components = options.components;\n    this.themes = options.themes;\n    this.configLoader = options.configLoader;\n    this.defaultApis = options.defaultApis;\n  }\n\n  getPlugins(): BackstagePlugin[] {\n    return this.plugins;\n  }\n\n  getSystemIcon(key: SystemIconKey): IconComponent {\n    return this.icons[key];\n  }\n\n  getRoutes(): JSX.Element[] {\n    const routes = new Array<JSX.Element>();\n    const registeredFeatureFlags = new Array<FeatureFlagsRegistryItem>();\n\n    const { NotFoundErrorPage } = this.components;\n\n    for (const plugin of this.plugins.values()) {\n      for (const output of plugin.output()) {\n        switch (output.type) {\n          case 'legacy-route': {\n            const { path, component: Component } = output;\n            routes.push(\n              <Route key={path} path={path} element={<Component />} />,\n            );\n            break;\n          }\n          case 'route': {\n            const { target, component: Component } = output;\n            routes.push(\n              <Route\n                key={`${plugin.getId()}-${target.path}`}\n                path={target.path}\n                element={<Component />}\n              />,\n            );\n            break;\n          }\n          case 'legacy-redirect-route': {\n            const { path, target } = output;\n            routes.push(<Navigate key={path} to={target} />);\n            break;\n          }\n          case 'redirect-route': {\n            const { from, to } = output;\n            routes.push(<Navigate key={from.path} to={to.path} />);\n            break;\n          }\n          case 'feature-flag': {\n            registeredFeatureFlags.push({\n              pluginId: plugin.getId(),\n              name: output.name,\n            });\n            break;\n          }\n          default:\n            break;\n        }\n      }\n    }\n\n    const featureFlags = this.getApiHolder().get(featureFlagsApiRef);\n    if (featureFlags) {\n      featureFlags.registeredFeatureFlags = registeredFeatureFlags;\n    }\n\n    routes.push(<Route path=\"/*\" element={<NotFoundErrorPage />} />);\n\n    return routes;\n  }\n\n  getProvider(): ComponentType<{}> {\n    const Provider: FC<{}> = ({ children }) => {\n      const appThemeApi = useMemo(\n        () => AppThemeSelector.createWithStorage(this.themes),\n        [],\n      );\n\n      const loadedConfig = useConfigLoader(\n        this.configLoader,\n        this.components,\n        appThemeApi,\n      );\n\n      if ('node' in loadedConfig) {\n        // Loading or error\n        return loadedConfig.node;\n      }\n\n      this.configApi = loadedConfig.api;\n\n      return (\n        <ApiProvider apis={this.getApiHolder()}>\n          <AppContextProvider app={this}>\n            <AppThemeProvider>{children}</AppThemeProvider>\n          </AppContextProvider>\n        </ApiProvider>\n      );\n    };\n    return Provider;\n  }\n\n  getRouter(): ComponentType<{}> {\n    const {\n      Router: RouterComponent,\n      SignInPage: SignInPageComponent,\n    } = this.components;\n\n    // This wraps the sign-in page and waits for sign-in to be completed before rendering the app\n    const SignInPageWrapper: FC<{\n      component: ComponentType<SignInPageProps>;\n      children: ReactElement;\n    }> = ({ component: Component, children }) => {\n      const [result, setResult] = useState<SignInResult>();\n\n      if (result) {\n        this.identityApi.setSignInResult(result);\n        return children;\n      }\n\n      return <Component onResult={setResult} />;\n    };\n\n    const AppRouter: FC<{}> = ({ children }) => {\n      const configApi = useApi(configApiRef);\n\n      let { pathname } = new URL(\n        configApi.getOptionalString('app.baseUrl') ?? '/',\n        'http://dummy.dev', // baseUrl can be specified as just a path\n      );\n      if (pathname.endsWith('/')) {\n        pathname = pathname.replace(/\\/$/, '');\n      }\n\n      // If the app hasn't configured a sign-in page, we just continue as guest.\n      if (!SignInPageComponent) {\n        this.identityApi.setSignInResult({\n          userId: 'guest',\n          profile: {\n            email: 'guest@example.com',\n            displayName: 'Guest',\n          },\n        });\n\n        return (\n          <RouterComponent>\n            <Routes>\n              <Route path={`${pathname}/*`} element={<>{children}</>} />\n            </Routes>\n          </RouterComponent>\n        );\n      }\n\n      return (\n        <RouterComponent>\n          <SignInPageWrapper component={SignInPageComponent}>\n            <Routes>\n              <Route path={`${pathname}/*`} element={<>{children}</>} />\n            </Routes>\n          </SignInPageWrapper>\n        </RouterComponent>\n      );\n    };\n\n    return AppRouter;\n  }\n\n  private getApiHolder(): ApiHolder {\n    if (this.apiHolder) {\n      return this.apiHolder;\n    }\n\n    const registry = new ApiFactoryRegistry();\n\n    registry.register('static', {\n      api: appThemeApiRef,\n      deps: {},\n      factory: () => AppThemeSelector.createWithStorage(this.themes),\n    });\n    registry.register('static', {\n      api: configApiRef,\n      deps: {},\n      factory: () => {\n        if (!this.configApi) {\n          throw new Error(\n            'Tried to access config API before config was loaded',\n          );\n        }\n        return this.configApi;\n      },\n    });\n    registry.register('static', {\n      api: identityApiRef,\n      deps: {},\n      factory: () => this.identityApi,\n    });\n\n    for (const factory of this.defaultApis) {\n      registry.register('default', factory);\n    }\n\n    for (const plugin of this.plugins) {\n      for (const factory of plugin.getApis()) {\n        if (!registry.register('default', factory)) {\n          throw new Error(\n            `Plugin ${plugin.getId()} tried to register duplicate or forbidden API factory for ${\n              factory.api\n            }`,\n          );\n        }\n      }\n    }\n\n    for (const factory of this.apis) {\n      if (!registry.register('app', factory)) {\n        throw new Error(\n          `Duplicate or forbidden API factory for ${factory.api} in app`,\n        );\n      }\n    }\n\n    ApiResolver.validateFactories(registry, registry.getAllApis());\n\n    this.apiHolder = new ApiResolver(registry);\n\n    return this.apiHolder;\n  }\n\n  verify() {\n    const pluginIds = new Set<string>();\n\n    for (const plugin of this.plugins) {\n      const id = plugin.getId();\n      if (pluginIds.has(id)) {\n        throw new Error(`Duplicate plugin found '${id}'`);\n      }\n      pluginIds.add(id);\n    }\n  }\n}\n"],"names":["ApiAggregator2","SessionStateTracker2","DEFAULT_PROVIDER","OAuth2Icon","GitlabIcon","GoogleIcon","OktaIcon","SamlIcon","Auth0Icon","MicrosoftIcon","hasScopes","OAuthPendingRequests2","Context","AppThemeProvider2","AppIdentity2","ApiFactoryRegistry2","ApiResolver2"],"mappings":"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"}